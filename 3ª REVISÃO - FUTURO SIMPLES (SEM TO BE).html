<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REVISÃO - FUTURO SIMPLES!!!</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px;
            min-height: 400px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #dc3545; /* Alterado para vermelho */
        }
        
        h2 {
            text-align: center;
            color: #444;
        }

        .question-card, .results-card, .intro-card {
            display: none;
            flex-direction: column;
        }

        .intro-card {
            display: flex;
            text-align: center;
        }

        .intro-card input {
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .option-item {
            background-color: #e9ecef;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        .option-item:hover {
            background-color: #d1e7dd;
        }

        .option-item.correct {
            background-color: #28a745;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }

        .option-item.incorrect {
            background-color: #dc3545;
            color: white;
            animation: shake 0.5s ease-in-out;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
        }

        .justification {
            margin-top: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 5px solid #007bff;
            border-radius: 5px;
            display: none;
        }

        .feedback {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }

        .feedback.correct-text {
            color: #28a745;
        }

        .feedback.incorrect-text {
            color: #dc3545;
        }

        .next-btn, .skip-btn, .hint-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            display: none;
            float: right;
            margin-left: 10px;
        }

        .skip-btn {
            background-color: #ffc107;
            color: #333;
        }

        .hint-btn {
            background-color: #6a0dad; /* Cor roxa para o botão Dica */
            display: inline-block;
            float: none;
        }

        .hint-text {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-left: 5px solid #6c757d;
            border-radius: 5px;
            font-style: italic;
            display: none;
        }

        .question-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap; /* Permite que os itens quebrem linha */
        }
        
        .start-btn, .restart-btn, .send-report-btn, .print-btn, .share-btn, .save-report-btn, .continue-btn {
            display: inline-block;
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
            animation: pulse 2s infinite;
        }

        .restart-btn {
            background-color: #dc3545;
        }

        .send-report-btn {
            background-color: #6c757d;
        }

        .print-btn {
            background-color: #007bff;
        }

        .results-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .share-btn {
            background-color: #25d366;
        }

        .share-btn img {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }

        .save-report-btn {
            background-color: #007bff;
        }

        .results-card h2 {
            margin-bottom: 20px;
        }

        .results-card p {
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .results-card .score-display {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-top: 10px;
        }

        .attempts-counter {
            text-align: right;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }

        .question-counter {
            text-align: left;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }

        .incorrect-questions-list {
            margin-top: 30px;
            border-top: 2px solid #ccc;
            padding-top: 20px;
        }

        .full-report-list {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ccc;
        }

        .incorrect-questions-list h3, .full-report-list h3 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .full-report-list h3 {
            color: #007bff;
        }

        .incorrect-question-item, .report-question-item {
            background-color: #fff3f3;
            border: 1px solid #f5c6cb;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .report-question-item {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
        }

        .incorrect-question-item p, .report-question-item p {
            margin: 5px 0;
        }

        .incorrect-question-item p strong, .report-question-item p strong {
            color: #333;
        }

        .incorrect-question-item .justification, .report-question-item .justification {
            background-color: #f8d7da;
            border-left: 5px solid #dc3545;
        }

        .report-question-item .option-item-report {
            background-color: #e9ecef;
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
        }

        .report-question-item .option-item-report.correct {
            background-color: #d4edda;
        }

        .report-question-item .option-item-report.incorrect {
            background-color: #f8d7da;
        }

        .classification-red {
            color: red;
        }

        .classification-blue {
            color: #007bff;
        }

        .classification-orange {
            color: #FFA500;
            font-weight: bold;
            animation: blink-text 1s linear infinite;
        }

        .performance-btn {
            background-color: #FFA500; /* Laranja */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            margin-left: 0; /* Ajustado para alinhar corretamente com flexbox */
            margin-right: auto; /* Empurra os outros botões para a direita */
        }

        .performance-display {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            border-radius: 5px;
            font-weight: bold;
            color: #856404;
            text-align: left;
        }

        @keyframes blink-text {
            50% {
                opacity: 0;
            }
        }

        /* Estilos específicos para impressão */
        @media print {
            body {
                background-color: #fff;
                padding-top: 0;
                display: block;
            }

            .container {
                box-shadow: none;
                border: none;
                width: 100%;
                max-width: none;
                min-height: auto;
            }

            #intro-card, #quiz-card, .results-actions, .print-btn, .attempts-counter, .question-counter {
                display: none !important;
            }

            #results-card {
                display: block !important;
            }

            .incorrect-questions-list, .full-report-list {
                display: block !important;
                border-top: 1px solid #ccc;
                padding-top: 10px;
            }

            .incorrect-question-item, .report-question-item {
                margin-bottom: 10px;
                border: 1px solid #ddd;
                background-color: #f9f9f9;
            }

            .report-question-item .justification {
                display: block !important;
                padding: 10px;
                margin-top: 5px;
                border-left: 3px solid #eee;
                background-color: #eee;
                font-size: 0.9em;
            }

            .report-question-item .option-item-report {
                margin: 3px 0;
                padding: 5px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="intro-card" class="intro-card">
            <h1>English Grammar Quiz</h1>
            <h2>REVISÃO FUTURO SIMPLES</h2>
            <p id="personalized-welcome" style="font-size: 1.2rem; font-weight: bold; margin-top: 10px; display: none;">Seja bem-vindo(a) e boa sorte!</p>
            <p id="quiz-description">Por favor, insira seu código de acesso para iniciar o teste. Ele tem 30 questões. Você tem tentativas <span id="intro-attempts-left">ilimitadas</span> para fazer este teste.</p>
            <input type="text" id="student-code" placeholder="Your Access Code!">
            <div id="start-actions">
                <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
            </div>
        </div>

        <div id="quiz-card" class="question-card">
            <div class="attempts-counter">Tentativas restantes: <span id="attempts-left">Ilimitadas</span></div>
            <div class="question-counter">Questão <span id="current-question-num">1</span> de 30</div>
            <div id="question-text" class="question-text"></div>
            <ul id="options-list" class="options-list"></ul>
            <div id="hint-container">
                <button id="hint-button" class="hint-btn" onclick="quizApp.showHint()">Dica</button>
                <div id="hint-text" class="hint-text"></div>
                <div id="summary-text" class="hint-text" style="border-left-color: #28a745;"></div>
            </div>
            <div class="question-actions">
                <button id="performance-btn" class="performance-btn">DESEMPENHO</button>
                <button id="summary-button" class="start-btn" onclick="quizApp.showSummary()" style="background-color: #28a745; display: none;">Resumo</button>
                <button id="skip-button" class="skip-btn" onclick="quizApp.skipQuestion()">Pular Questão</button>
                <button id="next-button" class="next-btn" onclick="quizApp.nextQuestion()">Próxima Questão</button>
                <div id="performance-display" class="performance-display" style="display: none;"></div>
            </div>
        </div>

        <div id="results-card" class="results-card">
            <h1>Relatório Final</h1>
            <p><strong>Nome:</strong> <span id="report-student-name"></span></p>
            <p><strong>Código de Acesso:</strong> <span id="report-student-code"></span></p>
            <p><strong>Pontuação:</strong> <span id="score-display"></span></p>
            <p><strong>Percentual de Acerto:</strong> <span id="percentage-display"></span></p>
            <p><strong>Classificação:</strong> <span id="classification-display"></span></p>
            <div class="results-actions">
                <a id="send-report-link" class="send-report-btn" href="#" target="_blank">Enviar Relatório ao Professor</a>
                <button class="restart-btn" onclick="quizApp.restartQuiz()">Reiniciar Teste</button>
                <a id="share-whatsapp" class="start-btn share-btn" href="#" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"> Compartilhar
                </a>
                <button class="start-btn save-report-btn" onclick="quizApp.saveReport()">Salvar Relatório</button>
                <button class="start-btn print-btn" onclick="quizApp.printReport()">Imprimir Relatório</button>
            </div>
            <div id="incorrect-questions-container" class="incorrect-questions-list"></div>
            <div id="full-report-container" class="full-report-list" style="display: none;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

    <script>
        const quizApp = {
            // SUBSTITUA A URL ABAIXO PELA URL DO SEU PRÓPRIO GOOGLE SCRIPT.
            APP_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwtDAlCCBcc3cN3pHX5YTvCZBsYTH--UJbeaczv64av_vIkybVIaEs-nTLKM2ssHND2/exec',
            
            currentQuestionIndex: 0,
            score: 0,
            userAnswers: {},
            validatedStudentName: '',
            validatedStudentCode: '',
            totalAttempts: "Ilimitadas",
            skippedQuestions: [], // Nova propriedade para armazenar questões puladas
            currentSkippedIndex: 0, // Nova propriedade para rastrear o índice das questões puladas
            
            // Elementos DOM
            elements: {
                studentCodeInput: document.getElementById('student-code'),
                introCard: document.getElementById('intro-card'),
                quizCard: document.getElementById('quiz-card'),
                resultsCard: document.getElementById('results-card'),
                questionText: document.getElementById('question-text'),
                optionsList: document.getElementById('options-list'),
                nextButton: document.getElementById('next-button'),
                skipButton: document.getElementById('skip-button'), // Novo elemento
                hintButton: document.getElementById('hint-button'),
                hintText: document.getElementById('hint-text'),
                attemptsLeftSpan: document.getElementById('attempts-left'),
                currentQuestionNumSpan: document.getElementById('current-question-num'),
                scoreDisplay: document.getElementById('score-display'),
                percentageDisplay: document.getElementById('percentage-display'),
                classificationDisplay: document.getElementById('classification-display'),
                reportStudentName: document.getElementById('report-student-name'),
                reportStudentCode: document.getElementById('report-student-code'),
                sendReportLink: document.getElementById('send-report-link'),
                introAttemptsLeftSpan: document.getElementById('intro-attempts-left'),
                incorrectQuestionsContainer: document.getElementById('incorrect-questions-container'),
                fullReportContainer: document.getElementById('full-report-container'),
                shareWhatsappLink: document.getElementById('share-whatsapp'),
                personalizedWelcome: document.getElementById('personalized-welcome'),
                startActionsDiv: document.getElementById('start-actions'),
                quizDescription: document.getElementById('quiz-description'),
                summaryButton: document.getElementById('summary-button'),
                summaryText: document.getElementById('summary-text'),
                performanceButton: document.getElementById('performance-btn'),
                performanceDisplay: document.getElementById('performance-display')
            },

            studentData: {
                "001AB": "ELMA", "002CD": "GUSTAVO", "003EF": "PIETRA", "004GH": "GEOVANNA", "005IJ": "LEOZINHO",
                "006KL": "MARIANA", "007MN": "NICOLAS", "008OP": "YAGO", "009QR": "CAIO", "010ST": "GIH",
                "011UV": "LUCAS RESENDE", "012WX": "BRUNA", "013YZ": "DIMI", "014AB": "FABRÍCIO", "015CD": "MIGUEL",
                "016EF": "YAGO", "017GH": "ANDRÉIA", "018IJ": "KAUÃ", "019KL": "PABLO", "020MN": "SURY",
                "021OP": "TAINÁ", "022QR": "YASMIN", "023ST": "MÁRCIA", "024UV": "RICK", "025WX": "ROSA",
                "026YZ": "FÁTIMA", "027AB": "LUCA", "028CD": "ALEX", "029EF": "DÉBORA", "030GH": "GIOVANNA",
                "031IJ": "PÂMELA", "032KL": "YASMIN", "033MN": "ADRIANO", "034OP": "ARTHUR", "035QR": "YASMIN",
                "036ST": "DAVI", "037UV": "DEREK", "038WX": "PEDRINHO", "039YZ": "DENILSON", "040AB": "EDSON",
                "041CD": "ALÍCIA", "042EF": "CAROLINA", "043GH": "ELSON", "044IJ": "LETÍCIA", "045KL": "DIEGO",
                "046MN": "GABI", "047OP": "KIM", "048QR": "LANA", "049ST": "MANU", "050UV": "SABRINA",
                "051WX": "BRUNA", "052YZ": "DIMI", "053AB": "FABRÍCIO", "054CD": "MIGUEL", "055EF": "YAGO",
                "056GH": "ANDRÉIA", "057IJ": "KAUÃ", "058KL": "PABLO", "059MN": "SURY", "060OP": "TAINÁ",
                "061QR": "YASMIN", "062ST": "MÁRCIA", "063UV": "RICK", "064WX": "ROSA", "065YZ": "FÁTIMA",
                "066AB": "LUCA", "067CD": "ALEX", "JR123": "JÚNIOR", "068EF": "DÉBORA", "069GH": "GIOVANNA", "070IJ": "PÂMELA",
                "071KL": "YASMIN", "072MN": "ADRIANO", "073OP": "ARTHUR", "074QR": "YASMIN", "075ST": "DAVI",
                "076UV": "DEREK", "077WX": "PEDRINHO", "078YZ": "DENILSON", "079AB": "EDSON", "080CD": "ALÍCIA",
                "081EF": "CAROLINA", "082GH": "ELSON", "083IJ": "LETÍCIA", "084KL": "DIEGO", "085MN": "GABI",
                "086OP": "KIM", "087QR": "LANA", "088ST": "MANU", "089UV": "SABRINA", "090WX": "DIMI", "101QR": "ANA CLARA", "102ST": "JOAQUIM",
                "091YZ": "FABRÍCIO", "092AB": "MIGUEL", "093CD": "YAGO", "094EF": "ANDRÉIA", "095GH": "KAUÃ",
                "096IJ": "PABLO", "097KL": "SURY", "098MN": "TAINÁ", "099OP": "YASMIN", "100QR": "MÁRCIA", "101ST": "MONIQUE", "102UV": "AURELIO"
            },
            
            summaries: {
                "General Use": "O Simple Future com 'will' é usado para expressar previsões, decisões instantâneas, promessas e fatos futuros.",
                "Affirmative Form": "A estrutura afirmativa é: Sujeito + will + verbo na forma base. A contração 'll (I'll, you'll) é muito comum.",
                "Negative Form": "A forma negativa é: Sujeito + will not (ou a contração won't) + verbo na forma base.",
                "Interrogative Form": "Para perguntas, a estrutura é: Will + sujeito + verbo na forma base?",
                "Key Rules": "'Will' é usado para todos os sujeitos (I, you, he, she...) e o verbo principal NUNCA muda, fica sempre na forma base (sem 's', 'ed', 'ing')."
            },
// --- INÍCIO DO CÓDIGO DE BALANCEAMENTO DE ALTERNATIVAS ---

            // Função utilitária para embaralhar um array (Algoritmo Fisher-Yates)
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            },

            // Função principal para forçar a distribuição uniforme das respostas corretas
            balanceCorrectAnswers() {
                const totalQuestions = this.questions.length;
                if (totalQuestions === 0) return;

                const numPositions = 4; // A, B, C, D
                
                // 1. Embaralha a ordem desejada para as posições [0, 1, 2, 3] entre as 40 questões.
                let desiredPositions = [];
                for (let i = 0; i < totalQuestions; i++) {
                    desiredPositions.push(i % numPositions);
                }
                this.shuffleArray(desiredPositions);
                
                // 2. Itera sobre cada questão para garantir o rebalanceamento.
                this.questions.forEach((q, index) => {
                    // Primeiro, embaralha as opções da questão para que a alternativa correta não
                    // fique sempre na mesma posição do código original.
                    this.shuffleArray(q.options);
                    
                    // Encontra a opção correta e a posição alvo
                    const correctOption = q.options.find(opt => opt.isCorrect);
                    if (!correctOption) return; // Segurança caso não haja resposta correta
                    
                    const targetIndex = desiredPositions[index]; // Posição alvo (0, 1, 2 ou 3)

                    // Se a resposta correta já estiver na posição alvo, não faz nada.
                    if (q.options[targetIndex] === correctOption) {
                        return;
                    }

                    // Remove a resposta correta da sua posição atual
                    const currentIndex = q.options.indexOf(correctOption);
                    q.options.splice(currentIndex, 1);
                    
                    // Insere a resposta correta na posição alvo (forçando o balanceamento)
                    q.options.splice(targetIndex, 0, correctOption);
                });

                console.log("Alternativas corretas rebalanceadas para 10 em cada posição (0, 1, 2, 3).");
            },

// --- FIM DO CÓDIGO DE BALANCEAMENTO DE ALTERNATIVAS ---
  "questions": [
    {
        "question": "1. She ______ travel next week.",
        "topic": "Affirmative Form",
        "hint": "Para formar o futuro simples, usamos um auxiliar antes do verbo principal.",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! A estrutura do futuro simples é 'sujeito + will + verbo base'." },
            { "text": "is going to", "isCorrect": false, "rationale": "Incorreto. Embora 'going to' também indique futuro, a estrutura com 'will' é mais direta aqui." },
            { "text": "wills", "isCorrect": false, "rationale": "Incorreto. O auxiliar 'will' nunca muda, independentemente do sujeito." },
            { "text": "travels", "isCorrect": false, "rationale": "Incorreto. Isso seria o presente simples. O futuro precisa do auxiliar 'will'." }
        ]
    },
    {
        "question": "2. I think it ______ tomorrow.",
        "topic": "General Use",
        "hint": "Esta frase é uma previsão sobre o tempo.",
        "options": [
            { "text": "will rain", "isCorrect": true, "rationale": "Correto! Usamos 'will' para fazer previsões sobre o futuro." },
            { "text": "rains", "isCorrect": false, "rationale": "Incorreto. 'Rains' está no presente. 'Tomorrow' indica futuro." },
            { "text": "rained", "isCorrect": false, "rationale": "Incorreto. 'Rained' está no passado." },
            { "text": "is rain", "isCorrect": false, "rationale": "Incorreto. A estrutura está gramaticalmente incorreta." }
        ]
    },
    {
        "question": "3. They ______ go to the party.",
        "topic": "Negative Form",
        "hint": "A forma negativa de 'will' é 'will not'. Qual é a contração?",
        "options": [
            { "text": "won't", "isCorrect": true, "rationale": "Correto! 'Won't' é a contração de 'will not' e é usada para negar no futuro." },
            { "text": "willn't", "isCorrect": false, "rationale": "Incorreto. Esta contração não existe. A forma correta é 'won't'." },
            { "text": "don't", "isCorrect": false, "rationale": "Incorreto. 'Don't' é usado para o presente, não para o futuro." },
            { "text": "didn't", "isCorrect": false, "rationale": "Incorreto. 'Didn't' é usado para o passado." }
        ]
    },
    {
        "question": "4. ______ you help me with this box?",
        "topic": "Interrogative Form",
        "hint": "Para fazer uma pergunta no futuro, o que vem antes do sujeito?",
        "options": [
            { "text": "Will", "isCorrect": true, "rationale": "Correto! As perguntas no futuro simples começam com 'Will', seguido pelo sujeito e o verbo." },
            { "text": "Do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para perguntas no presente." },
            { "text": "Are", "isCorrect": false, "rationale": "Incorreto. 'Are' é o verbo 'to be'." },
            { "text": "You will", "isCorrect": false, "rationale": "Incorreto. Para formar uma pergunta, a ordem é invertida: 'Will you...?'." }
        ]
    },
    {
        "question": "5. He promises he ______ late again.",
        "topic": "Negative Form",
        "hint": "Ele promete que 'não vai' chegar atrasado. Como se forma a negativa?",
        "options": [
            { "text": "won't be", "isCorrect": true, "rationale": "Correto! A promessa é de algo que não vai acontecer, então usamos 'won't' (will not) + o verbo base 'be'." },
            { "text": "will be", "isCorrect": false, "rationale": "Incorreto. Isso significaria 'ele vai chegar atrasado', o que contradiz a promessa." },
            { "text": "isn't", "isCorrect": false, "rationale": "Incorreto. 'Isn't' está no presente." },
            { "text": "will not to be", "isCorrect": false, "rationale": "Incorreto. Após 'will' ou 'won't', o verbo vem na forma base, sem 'to'." }
        ]
    },
    {
        "question": "6. What ______ they do next summer?",
        "topic": "Interrogative Form",
        "hint": "É uma pergunta com 'What' sobre planos futuros.",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! A estrutura é 'Wh- + will + sujeito + verbo base'." },
            { "text": "do", "isCorrect": false, "rationale": "Incorreto. 'Do' é o auxiliar do presente." },
            { "text": "did", "isCorrect": false, "rationale": "Incorreto. 'Did' é o auxiliar do passado." },
            { "text": "are", "isCorrect": false, "rationale": "Incorreto. 'Are' não é o auxiliar correto para o verbo de ação 'do' neste contexto." }
        ]
    },
    {
        "question": "7. The phone is ringing! Don't worry, I ______ it.",
        "topic": "General Use",
        "hint": "Esta é uma decisão tomada no momento da fala.",
        "options": [
            { "text": "will answer", "isCorrect": true, "rationale": "Correto! Usamos 'will' para decisões espontâneas, tomadas no momento da fala." },
            { "text": "answer", "isCorrect": false, "rationale": "Incorreto. A ação de atender ainda vai acontecer, então precisa do auxiliar de futuro." },
            { "text": "am answering", "isCorrect": false, "rationale": "Incorreto. 'Am answering' (present continuous) indica uma ação em progresso, não uma decisão de fazer algo." },
            { "text": "answered", "isCorrect": false, "rationale": "Incorreto. 'Answered' está no passado." }
        ]
    },
    {
        "question": "8. We ______ watch a movie later.",
        "topic": "Affirmative Form",
        "hint": "Esta frase expressa uma intenção futura de forma simples.",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! Para expressar uma ação futura, usamos 'will' antes do verbo principal." },
            { "text": "are", "isCorrect": false, "rationale": "Incorreto. 'Are' é o verbo 'to be' e não se encaixa aqui." },
            { "text": "watched", "isCorrect": false, "rationale": "Incorreto. 'Watched' está no passado, mas 'later' indica futuro." },
            { "text": "don't", "isCorrect": false, "rationale": "Incorreto. 'Don't' é para o presente e tornaria a frase negativa." }
        ]
    },
    {
        "question": "9. She will ______ to the meeting tomorrow.",
        "topic": "Key Rules",
        "hint": "Qual é a regra para o verbo que vem depois de 'will'?",
        "options": [
            { "text": "come", "isCorrect": true, "rationale": "Correto! Após 'will', o verbo principal deve estar sempre na sua forma base." },
            { "text": "comes", "isCorrect": false, "rationale": "Incorreto. Nunca adicionamos '-s' ao verbo depois de 'will', mesmo para 'he', 'she' ou 'it'." },
            { "text": "came", "isCorrect": false, "rationale": "Incorreto. 'Came' é o passado do verbo." },
            { "text": "coming", "isCorrect": false, "rationale": "Incorreto. 'Coming' é o gerúndio e não é usado após 'will'." }
        ]
    },
    {
        "question": "10. ______ they pass the test?",
        "topic": "Interrogative Form",
        "hint": "Como se inicia uma pergunta sobre uma previsão?",
        "options": [
            { "text": "Will", "isCorrect": true, "rationale": "Correto! A pergunta sobre o futuro é formada com 'Will' no início." },
            { "text": "Did", "isCorrect": false, "rationale": "Incorreto. 'Did' é para perguntas no passado." },
            { "text": "Does", "isCorrect": false, "rationale": "Incorreto. 'Does' é para perguntas no presente." },
            { "text": "Are", "isCorrect": false, "rationale": "Incorreto. 'Are' é o verbo 'to be'." }
        ]
    },
    {
        "question": "11. He ______ accept the job offer.",
        "topic": "Negative Form",
        "hint": "Ele 'não vai' aceitar. Como se forma a negativa de 'will accept'?",
        "options": [
            { "text": "will not", "isCorrect": true, "rationale": "Correto! 'Will not' é a forma completa da negação no futuro, antes do verbo base." },
            { "text": "not will", "isCorrect": false, "rationale": "Incorreto. A palavra 'not' vem depois de 'will'." },
            { "text": "doesn't", "isCorrect": false, "rationale": "Incorreto. 'Doesn't' é para o presente simples." },
            { "text": "will accepts", "isCorrect": false, "rationale": "Incorreto. A frase é negativa e o verbo não deve ter '-s'." }
        ]
    },
    {
        "question": "12. I'll ______ you tomorrow morning.",
        "topic": "Affirmative Form",
        "hint": "'I'll' é a contração de 'I will'. O que vem depois?",
        "options": [
            { "text": "call", "isCorrect": true, "rationale": "Correto! Após 'will' (ou sua contração 'll), o verbo fica na forma base." },
            { "text": "calls", "isCorrect": false, "rationale": "Incorreto. O verbo nunca recebe '-s' depois de 'will'." },
            { "text": "called", "isCorrect": false, "rationale": "Incorreto. 'Called' está no passado." },
            { "text": "to call", "isCorrect": false, "rationale": "Incorreto. Não usamos 'to' entre 'will' e o verbo principal." }
        ]
    },
    {
        "question": "13. When ______ the party start?",
        "topic": "Interrogative Form",
        "hint": "Esta é uma pergunta com 'When' para saber sobre um evento futuro.",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! A estrutura é 'When + will + sujeito + verbo'." },
            { "text": "does", "isCorrect": false, "rationale": "Incorreto. 'Does' é para o presente." },
            { "text": "is", "isCorrect": false, "rationale": "Incorreto. 'Is' não é o auxiliar para o verbo 'start' neste caso." },
            { "text": "did", "isCorrect": false, "rationale": "Incorreto. 'Did' é para o passado." }
        ]
    },
    {
        "question": "14. We ______ finish the project soon.",
        "topic": "Affirmative Form",
        "hint": "'Nós vamos terminar'. Como expressar essa ideia no futuro?",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! 'Will' é usado antes do verbo para indicar uma ação futura." },
            { "text": "finished", "isCorrect": false, "rationale": "Incorreto. 'Finished' é o passado, mas 'soon' (em breve) indica futuro." },
            { "text": "are", "isCorrect": false, "rationale": "Incorreto. A estrutura está incorreta." },
            { "text": "can", "isCorrect": false, "rationale": "Incorreto. 'Can' expressa habilidade, não uma ação futura simples." }
        ]
    },
    {
        "question": "15. I'm sure she ______ a new car next year.",
        "topic": "Affirmative Form",
        "hint": "A forma contraída de 'she will' é 'she'll'.",
        "options": [
            { "text": "she'll buy", "isCorrect": true, "rationale": "Correto! 'She'll' é a contração de 'she will', usada para falar do futuro." },
            { "text": "she buys", "isCorrect": false, "rationale": "Incorreto. 'She buys' está no presente. 'Next year' indica futuro." },
            { "text": "she won't buy", "isCorrect": false, "rationale": "Incorreto. 'Won't' é negativo, mas a frase sugere uma afirmação ('I'm sure')." },
            { "text": "she bought", "isCorrect": false, "rationale": "Incorreto. 'Bought' é o passado." }
        ]
    },
    {
        "question": "16. Why ______ he move to another city?",
        "topic": "Interrogative Form",
        "hint": "Esta é uma pergunta com 'Why' sobre uma ação futura.",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! A estrutura de pergunta com Wh- é 'Wh- + will + sujeito + verbo'." },
            { "text": "does", "isCorrect": false, "rationale": "Incorreto. 'Does' é usado para perguntas no presente." },
            { "text": "is", "isCorrect": false, "rationale": "Incorreto. Não se usa o verbo 'to be' como auxiliar para o verbo 'move' aqui." },
            { "text": "did", "isCorrect": false, "rationale": "Incorreto. 'Did' faria a pergunta ser sobre o passado." }
        ]
    },
    {
        "question": "17. 'I am very thirsty.' 'Okay, I ______ you a glass of water.'",
        "topic": "General Use",
        "hint": "Esta é uma oferta ou decisão feita no momento em que a pessoa diz que está com sede.",
        "options": [
            { "text": "will get", "isCorrect": true, "rationale": "Correto! Usamos 'will' para ofertas e decisões instantâneas." },
            { "text": "get", "isCorrect": false, "rationale": "Incorreto. A ação ainda vai acontecer, portanto, precisa do 'will'." },
            { "text": "got", "isCorrect": false, "rationale": "Incorreto. 'Got' é o passado." },
            { "text": "am getting", "isCorrect": false, "rationale": "Incorreto. 'Am getting' descreve algo já em andamento, enquanto 'will get' é uma decisão de fazer algo." }
        ]
    },
    {
        "question": "18. I promise I ______ tell anyone your secret.",
        "topic": "Negative Form",
        "hint": "A pessoa está prometendo 'não contar'. Qual é a forma negativa do futuro?",
        "options": [
            { "text": "won't", "isCorrect": true, "rationale": "Correto! 'Won't' (will not) é usado para fazer uma promessa negativa." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. 'Will tell' significaria 'vou contar', quebrando a promessa." },
            { "text": "don't", "isCorrect": false, "rationale": "Incorreto. 'Don't' é para o tempo presente." },
            { "text": "am not", "isCorrect": false, "rationale": "Incorreto. Estrutura gramatical incorreta." }
        ]
    },
    {
        "question": "19. The sun ______ rise at 6 a.m. tomorrow.",
        "topic": "General Use",
        "hint": "Isto é um fato futuro, algo que acontecerá com certeza.",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! Usamos 'will' para expressar fatos futuros e certezas." },
            { "text": "is", "isCorrect": false, "rationale": "Incorreto. Estrutura incorreta." },
            { "text": "rose", "isCorrect": false, "rationale": "Incorreto. 'Rose' é o passado de 'rise'." },
            { "text": "rises", "isCorrect": false, "rationale": "Incorreto. 'Rises' é o presente simples." }
        ]
    },
    {
        "question": "20. ______ we have homework tonight?",
        "topic": "Interrogative Form",
        "hint": "Uma pergunta sobre uma possibilidade futura.",
        "options": [
            { "text": "Will", "isCorrect": true, "rationale": "Correto! A pergunta sobre o futuro começa com 'Will'." },
            { "text": "Do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente ('Nós temos lição hoje?')." },
            { "text": "Did", "isCorrect": false, "rationale": "Incorreto. 'Did' é para o passado." },
            { "text": "Have", "isCorrect": false, "rationale": "Incorreto. 'Have' não é usado para iniciar este tipo de pergunta." }
        ]
    },
    {
        "question": "21. Don't worry, she ______ the exam.",
        "topic": "Affirmative Form",
        "hint": "Esta é uma previsão positiva sobre o futuro dela.",
        "options": [
            { "text": "will pass", "isCorrect": true, "rationale": "Correto! 'Will pass' é a forma correta para expressar essa previsão." },
            { "text": "passes", "isCorrect": false, "rationale": "Incorreto. 'Passes' está no presente." },
            { "text": "will passes", "isCorrect": false, "rationale": "Incorreto. Nunca adicionamos '-s' ao verbo depois de 'will'." },
            { "text": "passed", "isCorrect": false, "rationale": "Incorreto. 'Passed' está no passado." }
        ]
    },
    {
        "question": "22. They ______ travel this weekend because they are busy.",
        "topic": "Negative Form",
        "hint": "Eles estão ocupados, então eles 'não vão' viajar.",
        "options": [
            { "text": "won't", "isCorrect": true, "rationale": "Correto! 'Won't' (will not) é usado para expressar que uma ação futura não acontecerá." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. 'Will' contradiz a razão ('because they are busy')." },
            { "text": "can't", "isCorrect": false, "rationale": "Incorreto. Embora 'can't' (não podem) seja possível, 'won't' (não vão) encaixa melhor como um plano." },
            { "text": "didn't", "isCorrect": false, "rationale": "Incorreto. 'Didn't' é para o passado." }
        ]
    },
    {
        "question": "23. ______ she drive to work tomorrow?",
        "topic": "Interrogative Form",
        "hint": "Como perguntamos sobre a intenção futura de alguém?",
        "options": [
            { "text": "Will", "isCorrect": true, "rationale": "Correto! 'Will' inicia a pergunta sobre uma ação futura." },
            { "text": "Does", "isCorrect": false, "rationale": "Incorreto. 'Does' é para o presente (Ela dirige para o trabalho? - como rotina)." },
            { "text": "Is", "isCorrect": false, "rationale": "Incorreto. 'Is' não é usado como auxiliar para o verbo 'drive'." },
            { "text": "Did", "isCorrect": false, "rationale": "Incorreto. 'Did' é para o passado." }
        ]
    },
    {
        "question": "24. I am tired. I think I ______ go to bed now.",
        "topic": "General Use",
        "hint": "Esta é uma decisão que a pessoa tomou agora porque está cansada.",
        "options": [
            { "text": "'ll", "isCorrect": true, "rationale": "Correto! 'I'll' (I will) é usado para decisões tomadas no momento da fala." },
            { "text": "am", "isCorrect": false, "rationale": "Incorreto. 'I am go' não é uma estrutura correta." },
            { "text": "won't", "isCorrect": false, "rationale": "Incorreto. 'Won't' é negativo, mas a pessoa está cansada e provavelmente quer dormir." },
            { "text": "don't", "isCorrect": false, "rationale": "Incorreto. 'Don't' é para o presente." }
        ]
    },
    {
        "question": "25. How ______ you get there?",
        "topic": "Interrogative Form",
        "hint": "Pergunta com 'How' sobre um plano futuro.",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! A estrutura é 'How + will + sujeito + verbo'." },
            { "text": "do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente." },
            { "text": "are", "isCorrect": false, "rationale": "Incorreto. 'Are' não é o auxiliar para o verbo 'get'." },
            { "text": "did", "isCorrect": false, "rationale": "Incorreto. 'Did' é para o passado." }
        ]
    },
    {
        "question": "26. He will ______ his friends at the mall.",
        "topic": "Key Rules",
        "hint": "Lembre-se: o verbo depois de 'will' fica sempre na forma base.",
        "options": [
            { "text": "meet", "isCorrect": true, "rationale": "Correto! O verbo 'meet' está na sua forma base, como exigido depois de 'will'." },
            { "text": "meets", "isCorrect": false, "rationale": "Incorreto. O '-s' da terceira pessoa não é usado com 'will'." },
            { "text": "met", "isCorrect": false, "rationale": "Incorreto. 'Met' é o passado." },
            { "text": "meeting", "isCorrect": false, "rationale": "Incorreto. O gerúndio '-ing' não é usado depois de 'will'." }
        ]
    },
    {
        "question": "27. That bag looks heavy. I ______ it for you.",
        "topic": "General Use",
        "hint": "Isto é uma oferta de ajuda feita no momento.",
        "options": [
            { "text": "'ll carry", "isCorrect": true, "rationale": "Correto! Usamos a contração 'll (will) para fazer ofertas espontâneas." },
            { "text": "carry", "isCorrect": false, "rationale": "Incorreto. Falta o 'will' para indicar a oferta futura." },
            { "text": "carried", "isCorrect": false, "rationale": "Incorreto. 'Carried' está no passado." },
            { "text": "won't carry", "isCorrect": false, "rationale": "Incorreto. 'Won't' seria uma recusa em ajudar, o que não faz sentido no contexto." }
        ]
    },
    {
        "question": "28. My parents ______ visit us next month.",
        "topic": "Affirmative Form",
        "hint": "Uma frase simples sobre um plano futuro.",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! 'Will' é usado com todos os sujeitos, incluindo 'my parents' (they)." },
            { "text": "are", "isCorrect": false, "rationale": "Incorreto. A estrutura 'are visit' está incorreta." },
            { "text": "visited", "isCorrect": false, "rationale": "Incorreto. 'Visited' é passado, mas 'next month' é futuro." },
            { "text": "wills", "isCorrect": false, "rationale": "Incorreto. 'Will' nunca ganha '-s'." }
        ]
    },
    {
        "question": "29. It's cold in here. I ______ close the window.",
        "topic": "General Use",
        "hint": "Esta é uma decisão espontânea por causa do frio.",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! 'Will' é usado para uma decisão tomada no momento da fala." },
            { "text": "am", "isCorrect": false, "rationale": "Incorreto. 'I am close' não é gramaticalmente correto." },
            { "text": "don't", "isCorrect": false, "rationale": "Incorreto. 'Don't' é negativo e para o presente." },
            { "text": "closed", "isCorrect": false, "rationale": "Incorreto. 'Closed' é o passado." }
        ]
    },
    {
        "question": "30. I ______ send you the details by email soon.",
        "topic": "Affirmative Form",
        "hint": "Uma promessa ou um plano de enviar algo em breve.",
        "options": [
            { "text": "will", "isCorrect": true, "rationale": "Correto! A estrutura 'I will send' expressa corretamente essa intenção futura." },
            { "text": "sent", "isCorrect": false, "rationale": "Incorreto. 'Sent' é o passado, mas 'soon' indica futuro." },
            { "text": "sends", "isCorrect": false, "rationale": "Incorreto. 'Sends' é para o presente (he/she/it) e não se usa com 'I'." },
            { "text": "am", "isCorrect": false, "rationale": "Incorreto. A estrutura 'I am send' está incorreta." }
                    ]
                }
            ],

            startQuiz(continueFromSavedState) {
                const studentCode = this.elements.studentCodeInput.value.trim().toUpperCase();
                const correctName = this.studentData[studentCode];

                if (!correctName) {
                    alert("Código de acesso inválido. Por favor, verifique e tente novamente.");
                    return;
                }

                this.validatedStudentCode = studentCode;
                this.validatedStudentName = correctName;

                if (continueFromSavedState) {
                    this.loadQuizState(this.validatedStudentCode);
                } else {
                    this.currentQuestionIndex = 0;
                    this.score = 0;
                    this.userAnswers = {};
                    this.skippedQuestions = [];
                    this.currentSkippedIndex = 0;
		    this.balanceCorrectAnswers();
                    localStorage.removeItem(`quizState_${this.validatedStudentCode}`);

                    this.shuffledQuestions = this.shuffleArray([...this.questions]);
                }

                const storageKey = `quiz_attempts_${this.validatedStudentCode}`;
                let attempts = parseInt(localStorage.getItem(storageKey) || 0);
                localStorage.setItem(storageKey, attempts + 1);

                this.elements.studentCodeInput.style.display = 'none';
                this.elements.startActionsDiv.style.display = 'none';
                this.elements.quizDescription.style.display = 'none';

                this.elements.personalizedWelcome.textContent = `Bem-vindo(a), ${this.validatedStudentName}! Boa sorte!`;
                this.elements.personalizedWelcome.style.display = 'block';

                setTimeout(() => {
                    this.elements.introCard.style.display = 'none';
                    this.elements.quizCard.style.display = 'flex';
                    this.displayQuestion();
                }, 3000);
            },

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            displayQuestion() {
                this.elements.performanceDisplay.style.display = 'none';
                let questionToDisplay;
                let currentQuestionNumber;
                this.elements.hintText.style.display = 'none';
                this.elements.summaryText.style.display = 'none';
                this.elements.summaryButton.style.display = 'none';

                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
                    const skippedIndex = this.skippedQuestions[this.currentSkippedIndex];
                    questionToDisplay = this.questions[skippedIndex]; 
                    currentQuestionNumber = `(Pulada) ${this.currentSkippedIndex + 1} de ${this.skippedQuestions.length}`;
                    this.elements.skipButton.style.display = 'none';
                    this.elements.nextButton.textContent = 'Próxima Questão';
                } else if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    questionToDisplay = this.shuffledQuestions[this.currentQuestionIndex];
                    currentQuestionNumber = this.currentQuestionIndex + 1;
                    this.elements.skipButton.style.display = 'inline-block';
                    this.elements.nextButton.textContent = 'Próxima Questão';
                } else {
                    this.showResults();
                    return;
                }

                this.elements.currentQuestionNumSpan.textContent = currentQuestionNumber;
                this.elements.nextButton.style.display = 'none';
                this.elements.optionsList.innerHTML = '';
                this.elements.questionText.textContent = questionToDisplay.question;

                questionToDisplay.options.forEach((option, index) => {
                    const li = document.createElement('li');
                    li.className = 'option-item';
                    li.textContent = option.text;
                    li.onclick = () => this.selectOption(li, option);
                    this.elements.optionsList.appendChild(li);
                });
            },

            selectOption(selectedElement, selectedOption) {
                const options = document.querySelectorAll('.option-item');

                options.forEach(option => {
                    option.style.pointerEvents = 'none';
                });

                const justificationElement = document.createElement('div');
                justificationElement.className = 'justification';

                let currentQuestion;
                let originalQuestionIndex;

                if (this.currentQuestionIndex >= this.shuffledQuestions.length) {
                    originalQuestionIndex = this.skippedQuestions[this.currentSkippedIndex];
                    currentQuestion = this.questions[originalQuestionIndex];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    originalQuestionIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
                }

                const correctOptions = currentQuestion.options.filter(opt => opt.isCorrect);
                const correctOptionTexts = correctOptions.map(opt => opt.text);
                const isCorrect = correctOptionTexts.includes(selectedOption.text);

                if (isCorrect) {
                    this.score++;
                    selectedElement.classList.add('correct');
                    justificationElement.textContent = selectedOption.rationale;
                    justificationElement.style.borderColor = '#28a745';
                    this.elements.summaryButton.style.display = 'none';
                } else {
                    selectedElement.classList.add('incorrect');
                    const correctElements = Array.from(options).filter(el => correctOptionTexts.includes(el.textContent));
                    correctElements.forEach(el => el.classList.add('correct'));
                    justificationElement.textContent = selectedOption.rationale;
                    justificationElement.style.borderColor = '#dc3545';
                    this.elements.summaryButton.style.display = 'inline-block';
                }

                this.userAnswers[originalQuestionIndex] = {
                    question: currentQuestion.question,
                    userAnswer: selectedOption.text,
                    isCorrect: isCorrect,
                    correctAnswer: correctOptionTexts.join(' ou '),
                    rationale: selectedOption.rationale
                };

                selectedElement.parentNode.insertBefore(justificationElement, selectedElement.nextSibling);
                justificationElement.style.display = 'block';

                this.elements.nextButton.style.display = 'block';
                this.elements.skipButton.style.display = 'none'; 
                this.saveQuizState();
            },

            showPerformance() {
                const answeredCount = Object.keys(this.userAnswers).length;
                const correctCount = this.score;
                const incorrectCount = answeredCount - correctCount;

                this.elements.performanceDisplay.innerHTML = `Até agora: <span style="color: #28a745;">${correctCount} acertos</span> e <span style="color: #dc3545;">${incorrectCount} erros</span>.`;
                this.elements.performanceDisplay.style.display = 'block';
            },
            
            showHint() {
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }

                if (currentQuestion && currentQuestion.hint) {
                    this.elements.hintText.textContent = currentQuestion.hint;
                    this.elements.hintText.style.display = 'block';
                }
            },

            showSummary() {
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }
                
                const questionTopic = currentQuestion.topic;

                if (questionTopic && this.summaries[questionTopic]) {
                    this.elements.summaryText.textContent = this.summaries[questionTopic];
                    this.elements.summaryText.style.display = 'block';
                }
            },

            nextQuestion() {
                if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    this.currentQuestionIndex++;
                } else {
                    this.currentSkippedIndex++;
                }
                
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.currentSkippedIndex >= this.skippedQuestions.length) {
                    this.showResults();
                } else {
                    this.displayQuestion();
                }
            },

            skipQuestion() {
                if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    const originalIndex = this.questions.findIndex(q => q.question === this.shuffledQuestions[this.currentQuestionIndex].question);
                    this.skippedQuestions.push(originalIndex);
                }
                this.currentQuestionIndex++;
                this.displayQuestion();
            },

            getClassification(percentage) {
                if (percentage >= 86) return "Excelente!!!";
                if (percentage >= 71) return "Muito Bom!!";
                if (percentage >= 51) return "Bom!";
                if (percentage >= 0) return "Insatisfatório!";
                return "Classificação não disponível";
            },

            launchConfetti() {
                confetti({ particleCount: 600, spread: 70, origin: { y: 0.6 } });
                setTimeout(() => confetti({ particleCount: 450, spread: 90, origin: { x: 0, y: 0.8 } }), 500);
                setTimeout(() => confetti({ particleCount: 450, spread: 90, origin: { x: 1, y: 0.8 } }), 800);
                setTimeout(() => confetti({ particleCount: 300, spread: 120, origin: { y: 0.2 } }), 1000);
            },

            showResults() {
                this.elements.quizCard.style.display = 'none';
                this.elements.resultsCard.style.display = 'block';
                this.elements.incorrectQuestionsContainer.innerHTML = '';
                this.elements.fullReportContainer.innerHTML = '';
                localStorage.removeItem(`quizState_${this.validatedStudentCode}`);

                const percentage = Math.round((this.score / this.questions.length) * 100);
                const classificationText = this.getClassification(percentage);

                this.elements.reportStudentName.textContent = this.validatedStudentName;
                this.elements.reportStudentCode.textContent = this.validatedStudentCode;
                this.elements.scoreDisplay.textContent = `${this.score} de ${this.questions.length}`;
                this.elements.percentageDisplay.textContent = `${percentage}%`;

                this.elements.classificationDisplay.textContent = classificationText;
                this.elements.classificationDisplay.classList.remove('classification-red', 'classification-blue', 'classification-orange');
                if (classificationText === "Insatisfatório!") {
                    this.elements.classificationDisplay.classList.add('classification-red');
                } else if (classificationText === "Excelente!!!") {
                    this.launchConfetti();
                    this.elements.classificationDisplay.classList.add('classification-orange');
                    setTimeout(() => {
                        this.elements.classificationDisplay.classList.remove('classification-orange');
                        this.elements.classificationDisplay.style.color = '#FFA500';
                        this.elements.classificationDisplay.style.fontWeight = 'bold';
                        this.elements.classificationDisplay.style.animation = 'none';
                    }, 5000);
                } else if (classificationText === "Muito Bom!!" || classificationText === "Bom!") {
                    this.elements.classificationDisplay.classList.add('classification-blue');
                }

                this.elements.fullReportContainer.innerHTML = this.generateFullReportHtml();
                this.elements.fullReportContainer.style.display = 'block';

                const shareMessage = this.generateShareMessage(percentage, classificationText);
                const encodedMessage = encodeURIComponent(shareMessage);
                this.elements.shareWhatsappLink.href = `https://wa.me/?text=${encodedMessage}`;

                const data = {
                    nome: this.validatedStudentName,
                    codigo: this.validatedStudentCode,
                    pontuacao: `${this.score} de ${this.questions.length}`,
                    percentual: `${percentage}%`,
                    classificacao: classificationText,
                };

                fetch(this.APP_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'no-cors'
                })
                .then(() => console.log('Dados enviados com sucesso para a planilha!'))
                .catch(error => console.error('Erro ao enviar dados:', error));

                this.elements.sendReportLink.textContent = 'Relatório Enviado!';
                this.elements.sendReportLink.href = '#';
                this.elements.sendReportLink.onclick = (e) => e.preventDefault();
                this.elements.sendReportLink.style.cursor = 'default';
                this.elements.sendReportLink.style.backgroundColor = '#ccc';
            },

            generateFullReportHtml() {
                let html = '<h3>Relatório Completo de Respostas:</h3>';
                this.questions.forEach((question, index) => {
                    const userAnswerObj = this.userAnswers[index] || {};
                    const userAnswerText = userAnswerObj.userAnswer;
                    const isCorrect = userAnswerObj.isCorrect;
                    
                    html += `<div class="report-question-item">`;
                    html += `<p><strong>Questão ${index + 1}:</strong> ${question.question}</p>`;
                    html += `<ul style="list-style-type: none; padding-left: 0;">`;

                    question.options.forEach(option => {
                        const isUserAnswer = (option.text === userAnswerText);
                        const isCorrectOption = option.isCorrect;

                        let optionClass = '';
                        if (isCorrectOption) {
                            optionClass = 'correct';
                        } else if (isUserAnswer) {
                            optionClass = 'incorrect';
                        }

                        let textPrefix = '';
                        if (isUserAnswer && isCorrectOption) {
                            textPrefix = 'Sua Resposta Correta: ';
                        } else if (isCorrectOption) {
                            textPrefix = 'Resposta Correta: ';
                        } else if (isUserAnswer) {
                            textPrefix = 'Sua Resposta: ';
                        }

                        html += `<li class="option-item-report ${optionClass}">`;
                        html += `<p><strong>${textPrefix}</strong>${option.text}</p>`;
                        html += `<div class="justification" style="display: block;">${option.rationale}</div>`;
                        html += `</li>`;
                    });

                    html += '</ul></div>';
                });
                return html;
            },

            generateShareMessage(percentage, classificationText) {
                let message = `*Relatório Completo do Quiz de Inglês*\n\n`;
                message += `*Aluno(a):* ${this.validatedStudentName}\n`;
                message += `*Código de Acesso:* ${this.validatedStudentCode}\n`;
                message += `*Pontuação:* ${this.score} de ${this.questions.length}\n`;
                message += `*Percentual de Acerto:* ${percentage}%\n`;
                message += `*Classificação:* ${classificationText}\n\n`;
                message += `*--- Respostas ---*\n`;

                this.questions.forEach((question, index) => {
                    const userAnswerObj = this.userAnswers[index] || {};
                    const userAnswerText = userAnswerObj.userAnswer || 'Não respondida';
                    const isCorrect = userAnswerObj.isCorrect;
                    const correctAnswer = question.options.find(opt => opt.isCorrect).text;
                    const rationale = userAnswerObj.rationale || question.options.find(opt => opt.isCorrect).rationale;

                    message += `\n*Questão ${index + 1}:* ${question.question}\n`;
                    message += `_Sua resposta:_ ${isCorrect ? `😄` : `😢`} ${userAnswerText}\n`;
                    message += `_Resposta correta:_ ${correctAnswer}\n`;
                    message += `_Justificativa:_ ${rationale}\n`;
                });
                return message;
            },

            saveQuizState() {
                const quizState = {
                    questionIndex: this.currentQuestionIndex,
                    userResponses: this.userAnswers,
                    studentCode: this.validatedStudentCode,
                    studentName: this.validatedStudentName,
                    skippedQuestions: this.skippedQuestions,
                    currentSkippedIndex: this.currentSkippedIndex,
                    shuffledQuestions: this.shuffledQuestions // Salva a ordem embaralhada
                };
                localStorage.setItem(`quizState_${this.validatedStudentCode}`, JSON.stringify(quizState));
            },

            loadQuizState(studentCode) {
                const savedState = localStorage.getItem(`quizState_${studentCode}`);
                if (savedState) {
                    const quizState = JSON.parse(savedState);
                    if (quizState.studentCode === studentCode) {
                        this.currentQuestionIndex = quizState.questionIndex;
                        this.score = quizState.score || Object.values(quizState.userResponses).filter(a => a.isCorrect).length;
                        this.userAnswers = quizState.userResponses || {};
                        this.validatedStudentName = quizState.studentName;
                        this.validatedStudentCode = quizState.studentCode;
                        this.skippedQuestions = quizState.skippedQuestions || [];
                        this.currentSkippedIndex = quizState.currentSkippedIndex || 0;
                        this.shuffledQuestions = quizState.shuffledQuestions;
                        return true;
                    }
                }
                return false;
            },

            updateAttemptsDisplay(code) {
                this.elements.attemptsLeftSpan.textContent = "Ilimitadas";
                this.elements.introAttemptsLeftSpan.textContent = "ilimitadas";
                this.elements.startActionsDiv.innerHTML = '';
                
                if (this.loadQuizState(code)) {
                    const continueBtn = document.createElement('button');
                    continueBtn.textContent = 'Continuar Quiz';
                    continueBtn.className = 'start-btn continue-btn';
                    continueBtn.onclick = () => this.startQuiz(true);
                    this.elements.startActionsDiv.appendChild(continueBtn);

                    const newBtn = document.createElement('button');
                    newBtn.textContent = 'Iniciar Novo Quiz';
                    newBtn.className = 'start-btn';
                    newBtn.style.backgroundColor = '#dc3545';
                    newBtn.onclick = () => {
                        if (confirm("Você tem um progresso salvo. Deseja realmente começar um novo quiz e perder o progresso atual?")) {
                            this.startQuiz(false);
                        }
                    };
                    this.elements.startActionsDiv.appendChild(newBtn);
                } else {
                    const startBtn = document.createElement('button');
                    startBtn.textContent = 'Start Quiz';
                    startBtn.className = 'start-btn';
                    startBtn.onclick = () => this.startQuiz(false);
                    this.elements.startActionsDiv.appendChild(startBtn);
                }
            },

            restartQuiz() {
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.userAnswers = {};
                this.skippedQuestions = [];
                this.currentSkippedIndex = 0;

                const studentCode = this.elements.studentCodeInput.value.trim().toUpperCase();
                if (studentCode) {
                    localStorage.removeItem(`quizState_${studentCode}`);
                }

                this.elements.resultsCard.style.display = 'none';
                this.elements.quizCard.style.display = 'none';
                this.elements.introCard.style.display = 'flex';
                this.elements.studentCodeInput.value = '';
                this.elements.studentCodeInput.style.display = 'block';
                this.elements.personalizedWelcome.style.display = 'none';
                this.elements.quizDescription.style.display = 'block';
                this.elements.sendReportLink.textContent = 'Enviar Relatório ao Professor';
                this.elements.sendReportLink.href = '#';
                this.elements.sendReportLink.onclick = null;
                this.elements.sendReportLink.style.cursor = 'pointer';
                this.elements.sendReportLink.style.backgroundColor = '#6c757d';

                this.elements.startActionsDiv.innerHTML = '<button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>';
                this.elements.startActionsDiv.style.display = 'block';
            },

            saveReport() {
                const scoreText = this.elements.scoreDisplay.textContent;
                const percentage = Math.round((this.score / this.questions.length) * 100);
                const classificationText = this.elements.classificationDisplay.textContent;

                let reportContent = `Relatório Completo do Quiz de Inglês\n\n`;
                reportContent += `Nome: ${this.validatedStudentName}\n`;
                reportContent += `Código de Acesso: ${this.validatedStudentCode}\n`;
                reportContent += `Pontuação: ${scoreText}\n`;
                reportContent += `Percentual de Acerto: ${percentage}%\n`;
                reportContent += `Classificação: ${classificationText}\n\n`;
                reportContent += `--- Respostas ---\n`;

                this.questions.forEach((question, index) => {
                    const userAnswerObj = this.userAnswers[index] || {};
                    const userAnswerText = userAnswerObj.userAnswer || 'Não respondida';
                    const isCorrect = userAnswerObj.isCorrect;
                    const correctAnswer = question.options.find(opt => opt.isCorrect).text;
                    const rationale = userAnswerObj.rationale || question.options.find(opt => opt.isCorrect).rationale;

                    reportContent += `\nQuestão ${index + 1}: ${question.question}\n`;
                    reportContent += `Sua resposta: ${isCorrect ? `(CORRETA) ` : `(INCORRETA) `}${userAnswerText}\n`;
                    reportContent += `Resposta correta: ${correctAnswer}\n`;
                    reportContent += `Justificativa: ${rationale}\n`;
                });

                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Relatorio-Quiz-${this.validatedStudentName.replace(/ /g, '-')}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            printReport() {
                window.print();
            },

            init() {
                this.elements.studentCodeInput.addEventListener('input', (e) => {
                    e.target.value = e.target.value.toUpperCase();
                    const code = e.target.value.trim().toUpperCase();
                    if (this.studentData[code]) {
                        this.updateAttemptsDisplay(code);
                    } else {
                        this.elements.startActionsDiv.innerHTML = '<button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>';
                    }
                });

                this.elements.performanceButton.onclick = () => this.showPerformance();
                this.elements.nextButton.onclick = () => this.nextQuestion();
                this.elements.skipButton.onclick = () => this.skipQuestion(); // Nova função
                //this.elements.restartBtn.onclick = () => this.restartQuiz();
                //this.elements.saveReportBtn.onclick = () => this.saveReport();
                //this.elements.printBtn.onclick = () => this.printReport();

                const code = this.elements.studentCodeInput.value.trim().toUpperCase();
                if (this.studentData[code]) {
                    this.updateAttemptsDisplay(code);
                } else {
                    this.restartQuiz();
                }
            }
        };

        window.onload = function() {
            quizApp.init();
        };

    </script>
</body>

</html>
