<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REVISÃO - PASSADO SIMPLES!!!</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px;
            min-height: 400px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #dc3545; /* Alterado para vermelho */
        }
        
        h2 {
            text-align: center;
            color: #444;
        }

        .question-card, .results-card, .intro-card {
            display: none;
            flex-direction: column;
        }

        .intro-card {
            display: flex;
            text-align: center;
        }

        .intro-card input {
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .option-item {
            background-color: #e9ecef;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        .option-item:hover {
            background-color: #d1e7dd;
        }

        .option-item.correct {
            background-color: #28a745;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }

        .option-item.incorrect {
            background-color: #dc3545;
            color: white;
            animation: shake 0.5s ease-in-out;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
        }

        .justification {
            margin-top: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 5px solid #007bff;
            border-radius: 5px;
            display: none;
        }

        .feedback {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }

        .feedback.correct-text {
            color: #28a745;
        }

        .feedback.incorrect-text {
            color: #dc3545;
        }

        .next-btn, .skip-btn, .hint-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            display: none;
            float: right;
            margin-left: 10px;
        }

        .skip-btn {
            background-color: #ffc107;
            color: #333;
        }

        .hint-btn {
            background-color: #6a0dad; /* Cor roxa para o botão Dica */
            display: inline-block;
            float: none;
        }

        .hint-text {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-left: 5px solid #6c757d;
            border-radius: 5px;
            font-style: italic;
            display: none;
        }

        .question-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap; /* Permite que os itens quebrem linha */
        }
        
        .start-btn, .restart-btn, .send-report-btn, .print-btn, .share-btn, .save-report-btn, .continue-btn {
            display: inline-block;
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
            animation: pulse 2s infinite;
        }

        .restart-btn {
            background-color: #dc3545;
        }

        .send-report-btn {
            background-color: #6c757d;
        }

        .print-btn {
            background-color: #007bff;
        }

        .results-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .share-btn {
            background-color: #25d366;
        }

        .share-btn img {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }

        .save-report-btn {
            background-color: #007bff;
        }

        .results-card h2 {
            margin-bottom: 20px;
        }

        .results-card p {
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .results-card .score-display {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-top: 10px;
        }

        .attempts-counter {
            text-align: right;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }

        .question-counter {
            text-align: left;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }

        .incorrect-questions-list {
            margin-top: 30px;
            border-top: 2px solid #ccc;
            padding-top: 20px;
        }

        .full-report-list {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ccc;
        }

        .incorrect-questions-list h3, .full-report-list h3 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .full-report-list h3 {
            color: #007bff;
        }

        .incorrect-question-item, .report-question-item {
            background-color: #fff3f3;
            border: 1px solid #f5c6cb;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .report-question-item {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
        }

        .incorrect-question-item p, .report-question-item p {
            margin: 5px 0;
        }

        .incorrect-question-item p strong, .report-question-item p strong {
            color: #333;
        }

        .incorrect-question-item .justification, .report-question-item .justification {
            background-color: #f8d7da;
            border-left: 5px solid #dc3545;
        }

        .report-question-item .option-item-report {
            background-color: #e9ecef;
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
        }

        .report-question-item .option-item-report.correct {
            background-color: #d4edda;
        }

        .report-question-item .option-item-report.incorrect {
            background-color: #f8d7da;
        }

        .classification-red {
            color: red;
        }

        .classification-blue {
            color: #007bff;
        }

        .classification-orange {
            color: #FFA500;
            font-weight: bold;
            animation: blink-text 1s linear infinite;
        }

        .performance-btn {
            background-color: #FFA500; /* Laranja */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            margin-left: 0; /* Ajustado para alinhar corretamente com flexbox */
            margin-right: auto; /* Empurra os outros botões para a direita */
        }

        .performance-display {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            border-radius: 5px;
            font-weight: bold;
            color: #856404;
            text-align: left;
        }

        @keyframes blink-text {
            50% {
                opacity: 0;
            }
        }

        /* Estilos específicos para impressão */
        @media print {
            body {
                background-color: #fff;
                padding-top: 0;
                display: block;
            }

            .container {
                box-shadow: none;
                border: none;
                width: 100%;
                max-width: none;
                min-height: auto;
            }

            #intro-card, #quiz-card, .results-actions, .print-btn, .attempts-counter, .question-counter {
                display: none !important;
            }

            #results-card {
                display: block !important;
            }

            .incorrect-questions-list, .full-report-list {
                display: block !important;
                border-top: 1px solid #ccc;
                padding-top: 10px;
            }

            .incorrect-question-item, .report-question-item {
                margin-bottom: 10px;
                border: 1px solid #ddd;
                background-color: #f9f9f9;
            }

            .report-question-item .justification {
                display: block !important;
                padding: 10px;
                margin-top: 5px;
                border-left: 3px solid #eee;
                background-color: #eee;
                font-size: 0.9em;
            }

            .report-question-item .option-item-report {
                margin: 3px 0;
                padding: 5px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="intro-card" class="intro-card">
            <h1>English Grammar Quiz</h1>
            <h2>REVISÃO PASSADO SIMPLES</h2>
            <p id="personalized-welcome" style="font-size: 1.2rem; font-weight: bold; margin-top: 10px; display: none;">Seja bem-vindo(a) e boa sorte!</p>
            <p id="quiz-description">Por favor, insira seu código de acesso para iniciar o teste. Ele tem 30 questões. Você tem tentativas <span id="intro-attempts-left">ilimitadas</span> para fazer este teste.</p>
            <input type="text" id="student-code" placeholder="Your Access Code!">
            <div id="start-actions">
                <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
            </div>
        </div>

        <div id="quiz-card" class="question-card">
            <div class="attempts-counter">Tentativas restantes: <span id="attempts-left">Ilimitadas</span></div>
            <div class="question-counter">Questão <span id="current-question-num">1</span> de 30</div>
            <div id="question-text" class="question-text"></div>
            <ul id="options-list" class="options-list"></ul>
            <div id="hint-container">
                <button id="hint-button" class="hint-btn" onclick="quizApp.showHint()">Dica</button>
                <div id="hint-text" class="hint-text"></div>
                <div id="summary-text" class="hint-text" style="border-left-color: #28a745;"></div>
            </div>
            <div class="question-actions">
                <button id="performance-btn" class="performance-btn">DESEMPENHO</button>
                <button id="summary-button" class="start-btn" onclick="quizApp.showSummary()" style="background-color: #28a745; display: none;">Resumo</button>
                <button id="skip-button" class="skip-btn" onclick="quizApp.skipQuestion()">Pular Questão</button>
                <button id="next-button" class="next-btn" onclick="quizApp.nextQuestion()">Próxima Questão</button>
                <div id="performance-display" class="performance-display" style="display: none;"></div>
            </div>
        </div>

        <div id="results-card" class="results-card">
            <h1>Relatório Final</h1>
            <p><strong>Nome:</strong> <span id="report-student-name"></span></p>
            <p><strong>Código de Acesso:</strong> <span id="report-student-code"></span></p>
            <p><strong>Pontuação:</strong> <span id="score-display"></span></p>
            <p><strong>Percentual de Acerto:</strong> <span id="percentage-display"></span></p>
            <p><strong>Classificação:</strong> <span id="classification-display"></span></p>
            <div class="results-actions">
                <a id="send-report-link" class="send-report-btn" href="#" target="_blank">Enviar Relatório ao Professor</a>
                <button class="restart-btn" onclick="quizApp.restartQuiz()">Reiniciar Teste</button>
                <a id="share-whatsapp" class="start-btn share-btn" href="#" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"> Compartilhar
                </a>
                <button class="start-btn save-report-btn" onclick="quizApp.saveReport()">Salvar Relatório</button>
                <button class="start-btn print-btn" onclick="quizApp.printReport()">Imprimir Relatório</button>
            </div>
            <div id="incorrect-questions-container" class="incorrect-questions-list"></div>
            <div id="full-report-container" class="full-report-list" style="display: none;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

    <script>
        const quizApp = {
            // SUBSTITUA A URL ABAIXO PELA URL DO SEU PRÓPRIO GOOGLE SCRIPT.
            APP_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwtDAlCCBcc3cN3pHX5YTvCZBsYTH--UJbeaczv64av_vIkybVIaEs-nTLKM2ssHND2/exec',
            
            currentQuestionIndex: 0,
            score: 0,
            userAnswers: {},
            validatedStudentName: '',
            validatedStudentCode: '',
            totalAttempts: "Ilimitadas",
            skippedQuestions: [], // Nova propriedade para armazenar questões puladas
            currentSkippedIndex: 0, // Nova propriedade para rastrear o índice das questões puladas
            
            // Elementos DOM
            elements: {
                studentCodeInput: document.getElementById('student-code'),
                introCard: document.getElementById('intro-card'),
                quizCard: document.getElementById('quiz-card'),
                resultsCard: document.getElementById('results-card'),
                questionText: document.getElementById('question-text'),
                optionsList: document.getElementById('options-list'),
                nextButton: document.getElementById('next-button'),
                skipButton: document.getElementById('skip-button'), // Novo elemento
                hintButton: document.getElementById('hint-button'),
                hintText: document.getElementById('hint-text'),
                attemptsLeftSpan: document.getElementById('attempts-left'),
                currentQuestionNumSpan: document.getElementById('current-question-num'),
                scoreDisplay: document.getElementById('score-display'),
                percentageDisplay: document.getElementById('percentage-display'),
                classificationDisplay: document.getElementById('classification-display'),
                reportStudentName: document.getElementById('report-student-name'),
                reportStudentCode: document.getElementById('report-student-code'),
                sendReportLink: document.getElementById('send-report-link'),
                introAttemptsLeftSpan: document.getElementById('intro-attempts-left'),
                incorrectQuestionsContainer: document.getElementById('incorrect-questions-container'),
                fullReportContainer: document.getElementById('full-report-container'),
                shareWhatsappLink: document.getElementById('share-whatsapp'),
                personalizedWelcome: document.getElementById('personalized-welcome'),
                startActionsDiv: document.getElementById('start-actions'),
                quizDescription: document.getElementById('quiz-description'),
                summaryButton: document.getElementById('summary-button'),
                summaryText: document.getElementById('summary-text'),
                performanceButton: document.getElementById('performance-btn'),
                performanceDisplay: document.getElementById('performance-display')
            },

            studentData: {
                "001AB": "ELMA", "002CD": "GUSTAVO", "003EF": "PIETRA", "004GH": "GEOVANNA", "005IJ": "LEOZINHO",
                "006KL": "MARIANA", "007MN": "NICOLAS", "008OP": "YAGO", "009QR": "CAIO", "010ST": "GIH",
                "011UV": "LUCAS RESENDE", "012WX": "BRUNA", "013YZ": "DIMI", "014AB": "FABRÍCIO", "015CD": "MIGUEL",
                "016EF": "YAGO", "017GH": "ANDRÉIA", "018IJ": "KAUÃ", "019KL": "PABLO", "020MN": "SURY",
                "021OP": "TAINÁ", "022QR": "YASMIN", "023ST": "MÁRCIA", "024UV": "RICK", "025WX": "ROSA",
                "026YZ": "FÁTIMA", "027AB": "LUCA", "028CD": "ALEX", "029EF": "DÉBORA", "030GH": "GIOVANNA",
                "031IJ": "PÂMELA", "032KL": "YASMIN", "033MN": "ADRIANO", "034OP": "ARTHUR", "035QR": "YASMIN",
                "036ST": "DAVI", "037UV": "DEREK", "038WX": "PEDRINHO", "039YZ": "DENILSON", "040AB": "EDSON",
                "041CD": "ALÍCIA", "042EF": "CAROLINA", "043GH": "ELSON", "044IJ": "LETÍCIA", "045KL": "DIEGO",
                "046MN": "GABI", "047OP": "KIM", "048QR": "LANA", "049ST": "MANU", "050UV": "SABRINA",
                "051WX": "BRUNA", "052YZ": "DIMI", "053AB": "FABRÍCIO", "054CD": "MIGUEL", "055EF": "YAGO",
                "056GH": "ANDRÉIA", "057IJ": "KAUÃ", "058KL": "PABLO", "059MN": "SURY", "060OP": "TAINÁ",
                "061QR": "YASMIN", "062ST": "MÁRCIA", "063UV": "RICK", "064WX": "ROSA", "065YZ": "FÁTIMA",
                "066AB": "LUCA", "067CD": "ALEX", "JR123": "JÚNIOR", "068EF": "DÉBORA", "069GH": "GIOVANNA", "070IJ": "PÂMELA",
                "071KL": "YASMIN", "072MN": "ADRIANO", "073OP": "ARTHUR", "074QR": "YASMIN", "075ST": "DAVI",
                "076UV": "DEREK", "077WX": "PEDRINHO", "078YZ": "DENILSON", "079AB": "EDSON", "080CD": "ALÍCIA",
                "081EF": "CAROLINA", "082GH": "ELSON", "083IJ": "LETÍCIA", "084KL": "DIEGO", "085MN": "GABI",
                "086OP": "KIM", "087QR": "LANA", "088ST": "MANU", "089UV": "SABRINA", "090WX": "DIMI", "101QR": "ANA CLARA", "102ST": "JOAQUIM",
                "091YZ": "FABRÍCIO", "092AB": "MIGUEL", "093CD": "YAGO", "094EF": "ANDRÉIA", "095GH": "KAUÃ",
                "096IJ": "PABLO", "097KL": "SURY", "098MN": "TAINÁ", "099OP": "YASMIN", "100QR": "MÁRCIA", "101ST": "MONIQUE", "102UV": "AURELIO"
            },
            
            summaries: {
                "General Use": "O Simple Past é usado para falar de ações concluídas no passado, como eventos, hábitos passados ou situações específicas que já terminaram.",
                "Affirmative - Regular Verbs": "Em frases afirmativas, a maioria dos verbos (regulares) recebe a terminação '-ed' no final. Ex: work -> worked, play -> played.",
                "Affirmative - Irregular Verbs": "Alguns verbos (irregulares) têm uma forma própria no passado que precisa ser memorizada. Ex: go -> went, have -> had, buy -> bought.",
                "Negative Form (didn't)": "Para formar a negativa, usamos 'did not' (ou 'didn't') antes do verbo principal. IMPORTANTE: O verbo volta para a sua forma base (sem '-ed' ou forma irregular). Ex: I didn't go.",
                "Interrogative Form (Did)": "Para fazer perguntas, usamos o auxiliar 'Did' no início da frase. O verbo principal também volta para a forma base. Ex: Did you see the movie?",
                "WH-Questions": "Para perguntas com What, Where, When, etc., a estrutura é: Wh-word + did + sujeito + verbo na forma base. Ex: Where did they meet?"
            },
// --- INÍCIO DO CÓDIGO DE BALANCEAMENTO DE ALTERNATIVAS ---

            // Função utilitária para embaralhar um array (Algoritmo Fisher-Yates)
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            },

            // Função principal para forçar a distribuição uniforme das respostas corretas
            balanceCorrectAnswers() {
                const totalQuestions = this.questions.length;
                if (totalQuestions === 0) return;

                const numPositions = 4; // A, B, C, D
                
                // 1. Embaralha a ordem desejada para as posições [0, 1, 2, 3] entre as 40 questões.
                let desiredPositions = [];
                for (let i = 0; i < totalQuestions; i++) {
                    desiredPositions.push(i % numPositions);
                }
                this.shuffleArray(desiredPositions);
                
                // 2. Itera sobre cada questão para garantir o rebalanceamento.
                this.questions.forEach((q, index) => {
                    // Primeiro, embaralha as opções da questão para que a alternativa correta não
                    // fique sempre na mesma posição do código original.
                    this.shuffleArray(q.options);
                    
                    // Encontra a opção correta e a posição alvo
                    const correctOption = q.options.find(opt => opt.isCorrect);
                    if (!correctOption) return; // Segurança caso não haja resposta correta
                    
                    const targetIndex = desiredPositions[index]; // Posição alvo (0, 1, 2 ou 3)

                    // Se a resposta correta já estiver na posição alvo, não faz nada.
                    if (q.options[targetIndex] === correctOption) {
                        return;
                    }

                    // Remove a resposta correta da sua posição atual
                    const currentIndex = q.options.indexOf(correctOption);
                    q.options.splice(currentIndex, 1);
                    
                    // Insere a resposta correta na posição alvo (forçando o balanceamento)
                    q.options.splice(targetIndex, 0, correctOption);
                });

                console.log("Alternativas corretas rebalanceadas para 10 em cada posição (0, 1, 2, 3).");
            },

// --- FIM DO CÓDIGO DE BALANCEAMENTO DE ALTERNATIVAS ---
  "questions": [
    {
        "question": "1. I ______ my grandmother yesterday.",
        "topic": "Affirmative - Regular Verbs",
        "hint": "O verbo 'visit' é regular. Como ele fica no passado?",
        "options": [
            { "text": "visited", "isCorrect": true, "rationale": "Correto! Para verbos regulares como 'visit', adicionamos '-ed' para formar o passado simples." },
            { "text": "visit", "isCorrect": false, "rationale": "Incorreto. 'Visit' está no presente. A palavra 'yesterday' indica que a ação está no passado." },
            { "text": "did visit", "isCorrect": false, "rationale": "Incorreto. 'Did' é usado em perguntas e negativas, não em frases afirmativas." },
            { "text": "visiting", "isCorrect": false, "rationale": "Incorreto. 'Visiting' é o gerúndio (usado no Past Continuous), não o Simple Past." }
        ]
    },
    {
        "question": "2. She ______ to the park last weekend.",
        "topic": "Affirmative - Irregular Verbs",
        "hint": "O verbo 'go' é irregular. Qual é a sua forma no passado?",
        "options": [
            { "text": "went", "isCorrect": true, "rationale": "Correto! 'Went' é a forma irregular do passado do verbo 'go'." },
            { "text": "goed", "isCorrect": false, "rationale": "Incorreto. 'Go' é um verbo irregular e não segue a regra de adicionar '-ed'." },
            { "text": "go", "isCorrect": false, "rationale": "Incorreto. 'Go' está no presente. 'Last weekend' indica uma ação no passado." },
            { "text": "did go", "isCorrect": false, "rationale": "Incorreto. O auxiliar 'did' não é usado em frases afirmativas." }
        ]
    },
    {
        "question": "3. They ______ the movie.",
        "topic": "Negative Form (didn't)",
        "hint": "Como formamos uma frase negativa no passado? Lembre-se que o verbo principal volta ao normal.",
        "options": [
            { "text": "didn't see", "isCorrect": true, "rationale": "Correto! Usamos 'didn't' e o verbo na forma base ('see') para formar a negativa no passado." },
            { "text": "didn't saw", "isCorrect": false, "rationale": "Incorreto. Após 'didn't', o verbo deve voltar para a sua forma base ('see'), e não ficar no passado ('saw')." },
            { "text": "not saw", "isCorrect": false, "rationale": "Incorreto. Para negar no Simple Past, precisamos do verbo auxiliar 'did'." },
            { "text": "don't see", "isCorrect": false, "rationale": "Incorreto. 'Don't' é o auxiliar do presente. Para o passado, usamos 'didn't'." }
        ]
    },
    {
        "question": "4. ______ you ______ your homework?",
        "topic": "Interrogative Form (Did)",
        "hint": "Qual auxiliar usamos para iniciar uma pergunta no passado?",
        "options": [
            { "text": "Did / finish", "isCorrect": true, "rationale": "Correto! Usamos 'Did' para iniciar a pergunta e o verbo principal na sua forma base ('finish')." },
            { "text": "Did / finished", "isCorrect": false, "rationale": "Incorreto. Quando usamos 'Did', o verbo principal não leva '-ed'." },
            { "text": "Do / finished", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente e o verbo não deveria estar com '-ed'." },
            { "text": "You / finished", "isCorrect": false, "rationale": "Incorreto. Uma pergunta no Simple Past precisa começar com o auxiliar 'Did'." }
        ]
    },
    {
        "question": "5. He ______ a new car last month.",
        "topic": "Affirmative - Irregular Verbs",
        "hint": "O verbo 'buy' (comprar) é irregular. Qual é o passado dele?",
        "options": [
            { "text": "bought", "isCorrect": true, "rationale": "Correto! 'Bought' é a forma do passado do verbo irregular 'buy'." },
            { "text": "buyed", "isCorrect": false, "rationale": "Incorreto. 'Buy' é irregular e não se adiciona '-ed'." },
            { "text": "did buy", "isCorrect": false, "rationale": "Incorreto. Não usamos 'did' em frases afirmativas." },
            { "text": "was buy", "isCorrect": false, "rationale": "Incorreto. 'Was' é o verbo 'to be', e a estrutura está incorreta." }
        ]
    },
    {
        "question": "6. We ______ English together for the test.",
        "topic": "Affirmative - Regular Verbs",
        "hint": "O verbo 'study' termina em consoante + 'y'. Como ele fica no passado?",
        "options": [
            { "text": "studied", "isCorrect": true, "rationale": "Correto! Para verbos terminados em consoante + 'y', trocamos o 'y' por '-ied'." },
            { "text": "studyed", "isCorrect": false, "rationale": "Incorreto. A grafia está errada. O 'y' deve ser trocado por 'i' antes de adicionar '-ed'." },
            { "text": "studyd", "isCorrect": false, "rationale": "Incorreto. A grafia está incorreta. A regra é trocar 'y' por '-ied'." },
            { "text": "did study", "isCorrect": false, "rationale": "Incorreto. Esta é uma frase afirmativa, então não usamos 'did'." }
        ]
    },
    {
        "question": "7. She ______ me yesterday.",
        "topic": "Negative Form (didn't)",
        "hint": "Para fazer a negativa do verbo 'call' no passado, usamos o auxiliar e o verbo na forma base.",
        "options": [
            { "text": "didn't call", "isCorrect": true, "rationale": "Correto! A estrutura da negativa é 'didn't' + verbo na forma base." },
            { "text": "didn't called", "isCorrect": false, "rationale": "Erro comum! Depois de 'didn't', o verbo não pode ter '-ed'." },
            { "text": "not call", "isCorrect": false, "rationale": "Incorreto. É obrigatório o uso do auxiliar 'did' para negar." },
            { "text": "doesn't call", "isCorrect": false, "rationale": "Incorreto. 'Doesn't' é para o tempo presente, não o passado." }
        ]
    },
    {
        "question": "8. What ______ you do last night?",
        "topic": "WH-Questions",
        "hint": "Em perguntas com 'What', 'Where', etc., qual auxiliar usamos antes do sujeito?",
        "options": [
            { "text": "did", "isCorrect": true, "rationale": "Correto! A estrutura é 'What' + 'did' + sujeito + verbo base." },
            { "text": "do", "isCorrect": false, "rationale": "Incorreto. 'Do' é o auxiliar do presente." },
            { "text": "were", "isCorrect": false, "rationale": "Incorreto. 'Were' é o verbo 'to be' no passado, não um auxiliar para o verbo 'do'." },
            { "text": "--- (nada)", "isCorrect": false, "rationale": "Incorreto. Uma pergunta com um verbo de ação no passado precisa do auxiliar 'did'." }
        ]
    },
    {
        "question": "9. The concert ______ at 8 PM.",
        "topic": "General Use",
        "hint": "A frase descreve um evento específico que começou e terminou no passado.",
        "options": [
            { "text": "started", "isCorrect": true, "rationale": "Correto! 'Start' é um verbo regular, então adicionamos '-ed' para formar o passado." },
            { "text": "start", "isCorrect": false, "rationale": "Incorreto. 'Start' está no presente." },
            { "text": "did start", "isCorrect": false, "rationale": "Incorreto. 'Did' não é usado em afirmações." },
            { "text": "was start", "isCorrect": false, "rationale": "Incorreto. A estrutura está errada. Não usamos o verbo 'to be' aqui." }
        ]
    },
    {
        "question": "10. He ______ a cold last week.",
        "topic": "Affirmative - Irregular Verbs",
        "hint": "O verbo 'have' (ter) é irregular. Qual é a sua forma no passado?",
        "options": [
            { "text": "had", "isCorrect": true, "rationale": "Correto! 'Had' é a forma do passado simples do verbo irregular 'have'." },
            { "text": "haved", "isCorrect": false, "rationale": "Incorreto. 'Have' é um verbo irregular e não segue a regra do '-ed'." },
            { "text": "did have", "isCorrect": false, "rationale": "Incorreto. Não se usa 'did' em frases afirmativas." },
            { "text": "has", "isCorrect": false, "rationale": "Incorreto. 'Has' é a forma do presente para 'he/she/it'." }
        ]
    },
    {
        "question": "11. ______ they ______ the car?",
        "topic": "Interrogative Form (Did)",
        "hint": "Esta é uma pergunta no passado. Lembre-se do auxiliar e da forma do verbo principal.",
        "options": [
            { "text": "Did / fix", "isCorrect": true, "rationale": "Correto! A pergunta começa com 'Did' e o verbo 'fix' fica na sua forma base." },
            { "text": "Did / fixed", "isCorrect": false, "rationale": "Incorreto. Na presença do auxiliar 'Did', o verbo principal não recebe '-ed'." },
            { "text": "Do / fix", "isCorrect": false, "rationale": "Incorreto. 'Do' é o auxiliar do presente, não do passado." },
            { "text": "Fixed / they", "isCorrect": false, "rationale": "Incorreto. A estrutura da pergunta está errada. Deve começar com 'Did'." }
        ]
    },
    {
        "question": "12. I ______ the new episode last night.",
        "topic": "Affirmative - Regular Verbs",
        "hint": "O verbo 'watch' (assistir) é regular.",
        "options": [
            { "text": "watched", "isCorrect": true, "rationale": "Correto! Sendo um verbo regular, adicionamos '-ed' para o passado." },
            { "text": "watch", "isCorrect": false, "rationale": "Incorreto. A expressão 'last night' exige o verbo no passado." },
            { "text": "was watch", "isCorrect": false, "rationale": "Incorreto. Estrutura incorreta." },
            { "text": "did watch", "isCorrect": false, "rationale": "Incorreto. 'Did' é usado apenas para perguntas e negativas." }
        ]
    },
    {
        "question": "13. Why ______ we leave so early?",
        "topic": "WH-Questions",
        "hint": "É uma pergunta no passado com 'Why'. Qual auxiliar deve vir depois?",
        "options": [
            { "text": "did", "isCorrect": true, "rationale": "Correto! A estrutura para WH-questions é: WH-word + did + sujeito + verbo." },
            { "text": "do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente." },
            { "text": "were", "isCorrect": false, "rationale": "Incorreto. 'Were' é o verbo 'to be' e não o auxiliar para o verbo 'leave'." },
            { "text": "left", "isCorrect": false, "rationale": "Incorreto. O auxiliar 'did' deve vir antes do sujeito 'we'." }
        ]
    },
    {
        "question": "14. They ______ the phone.",
        "topic": "Negative Form (didn't)",
        "hint": "Para negar a ação de 'answer' (atender) no passado.",
        "options": [
            { "text": "didn't answer", "isCorrect": true, "rationale": "Correto! Usamos o auxiliar 'didn't' seguido do verbo na forma base." },
            { "text": "didn't answered", "isCorrect": false, "rationale": "Incorreto. Após 'didn't', o verbo 'answer' não deve ter '-ed'." },
            { "text": "not answered", "isCorrect": false, "rationale": "Incorreto. A negação no Simple Past requer o auxiliar 'did'." },
            { "text": "weren't answer", "isCorrect": false, "rationale": "Incorreto. 'Weren't' é a negativa do verbo 'to be'." }
        ]
    },
    {
        "question": "15. He ______ the answer.",
        "topic": "Affirmative - Irregular Verbs",
        "hint": "O passado do verbo irregular 'know' (saber) é...",
        "options": [
            { "text": "knew", "isCorrect": true, "rationale": "Correto! 'Knew' é a forma correta do passado do verbo 'know'." },
            { "text": "knowed", "isCorrect": false, "rationale": "Incorreto. 'Know' é um verbo irregular e não aceita '-ed'." },
            { "text": "did know", "isCorrect": false, "rationale": "Incorreto. Não usamos 'did' em frases afirmativas." },
            { "text": "knewn", "isCorrect": false, "rationale": "Incorreto. 'Known' é o particípio passado, usado em outros tempos verbais." }
        ]
    },
    {
        "question": "16. We ______ until late last Friday.",
        "topic": "Affirmative - Regular Verbs",
        "hint": "O verbo 'work' (trabalhar) é regular.",
        "options": [
            { "text": "worked", "isCorrect": true, "rationale": "Correto! O passado de 'work' é 'worked'." },
            { "text": "work", "isCorrect": false, "rationale": "Incorreto. 'Last Friday' indica que a ação está no passado." },
            { "text": "did work", "isCorrect": false, "rationale": "Incorreto. 'Did' não é usado em frases afirmativas." },
            { "text": "was work", "isCorrect": false, "rationale": "Incorreto. A estrutura está errada." }
        ]
    },
    {
        "question": "17. ______ he sleep well last night?",
        "topic": "Interrogative Form (Did)",
        "hint": "Para perguntar sobre uma ação passada, começamos com...",
        "options": [
            { "text": "Did", "isCorrect": true, "rationale": "Correto! Usamos 'Did' para iniciar a pergunta no passado para todos os sujeitos." },
            { "text": "Does", "isCorrect": false, "rationale": "Incorreto. 'Does' é para perguntas no presente." },
            { "text": "Was", "isCorrect": false, "rationale": "Incorreto. 'Was' é o verbo 'to be', não um auxiliar para o verbo 'sleep'." },
            { "text": "Slept", "isCorrect": false, "rationale": "Incorreto. A pergunta deve começar com o auxiliar 'Did'." }
        ]
    },
    {
        "question": "18. I ______ breakfast this morning.",
        "topic": "Negative Form (didn't)",
        "hint": "A frase é 'Eu não comi...'. Como fica o verbo 'eat' na negativa do passado?",
        "options": [
            { "text": "didn't eat", "isCorrect": true, "rationale": "Correto! A estrutura é 'didn't' + a forma base do verbo ('eat')." },
            { "text": "didn't ate", "isCorrect": false, "rationale": "Incorreto. O verbo deve voltar para a forma base ('eat') depois de 'didn't'." },
            { "text": "not eat", "isCorrect": false, "rationale": "Incorreto. Falta o auxiliar 'did' para formar a negação." },
            { "text": "ate not", "isCorrect": false, "rationale": "Incorreto. A estrutura da negação está errada." }
        ]
    },
    {
        "question": "19. They ______ soccer when they were kids.",
        "topic": "General Use",
        "hint": "A frase descreve um hábito no passado. O verbo 'play' é regular.",
        "options": [
            { "text": "played", "isCorrect": true, "rationale": "Correto! Para expressar um hábito no passado, usamos o Simple Past. 'Played' é o passado de 'play'." },
            { "text": "play", "isCorrect": false, "rationale": "Incorreto. A expressão 'when they were kids' coloca a ação no passado." },
            { "text": "were play", "isCorrect": false, "rationale": "Incorreto. Estrutura incorreta." },
            { "text": "did play", "isCorrect": false, "rationale": "Incorreto. 'Did' não é usado em frases afirmativas." }
        ]
    },
    {
        "question": "20. When ______ she arrive?",
        "topic": "WH-Questions",
        "hint": "É uma pergunta com 'When' no passado.",
        "options": [
            { "text": "did", "isCorrect": true, "rationale": "Correto! A estrutura é: When + did + sujeito + verbo base." },
            { "text": "does", "isCorrect": false, "rationale": "Incorreto. 'Does' é o auxiliar do presente." },
            { "text": "was", "isCorrect": false, "rationale": "Incorreto. 'Was' é o verbo 'to be', não o auxiliar para 'arrive'." },
            { "text": "arrived", "isCorrect": false, "rationale": "Incorreto. O auxiliar 'did' deve vir antes do sujeito 'she'." }
        ]
    },
    {
        "question": "21. He ______ a letter to his friend.",
        "topic": "Affirmative - Irregular Verbs",
        "hint": "O verbo 'write' (escrever) é irregular.",
        "options": [
            { "text": "wrote", "isCorrect": true, "rationale": "Correto! 'Wrote' é o passado simples do verbo irregular 'write'." },
            { "text": "writed", "isCorrect": false, "rationale": "Incorreto. 'Write' é um verbo irregular e não termina em '-ed'." },
            { "text": "did write", "isCorrect": false, "rationale": "Incorreto. Não usamos 'did' em frases afirmativas." },
            { "text": "written", "isCorrect": false, "rationale": "Incorreto. 'Written' é o particípio passado." }
        ]
    },
    {
        "question": "22. ______ we win the game?",
        "topic": "Interrogative Form (Did)",
        "hint": "Para fazer a pergunta 'Nós ganhamos...?' no passado.",
        "options": [
            { "text": "Did", "isCorrect": true, "rationale": "Correto! Usamos 'Did' para iniciar a pergunta." },
            { "text": "Do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente." },
            { "text": "Won", "isCorrect": false, "rationale": "Incorreto. 'Won' é a resposta, mas a pergunta precisa começar com 'Did'." },
            { "text": "Were", "isCorrect": false, "rationale": "Incorreto. 'Were' é o verbo 'to be'." }
        ]
    },
    {
        "question": "23. I ______ to Spain in 2019.",
        "topic": "Affirmative - Regular Verbs",
        "hint": "O verbo 'travel' (viajar) é regular.",
        "options": [
            { "text": "traveled", "isCorrect": true, "rationale": "Correto! O passado de 'travel' é 'traveled'." },
            { "text": "travel", "isCorrect": false, "rationale": "Incorreto. A data 'in 2019' indica uma ação no passado." },
            { "text": "did travel", "isCorrect": false, "rationale": "Incorreto. 'Did' não se usa em frases afirmativas." },
            { "text": "was travel", "isCorrect": false, "rationale": "Incorreto. Estrutura gramaticalmente incorreta." }
        ]
    },
    {
        "question": "24. Where ______ they meet?",
        "topic": "WH-Questions",
        "hint": "Pergunta no passado com 'Where' (Onde).",
        "options": [
            { "text": "did", "isCorrect": true, "rationale": "Correto! A pergunta requer o auxiliar 'did' após a WH-word." },
            { "text": "do", "isCorrect": false, "rationale": "Incorreto. 'Do' é o auxiliar do presente." },
            { "text": "met", "isCorrect": false, "rationale": "Incorreto. O auxiliar 'did' deve vir antes do sujeito 'they'." },
            { "text": "were", "isCorrect": false, "rationale": "Incorreto. 'Were' é o verbo 'to be', não o auxiliar para 'meet'." }
        ]
    },
    {
        "question": "25. She ______ the house last Saturday.",
        "topic": "Affirmative - Regular Verbs",
        "hint": "O verbo 'clean' (limpar) é regular.",
        "options": [
            { "text": "cleaned", "isCorrect": true, "rationale": "Correto! Adicionamos '-ed' ao verbo regular 'clean'." },
            { "text": "clean", "isCorrect": false, "rationale": "Incorreto. 'Last Saturday' indica uma ação no passado." },
            { "text": "did clean", "isCorrect": false, "rationale": "Incorreto. Não se usa 'did' em afirmações." },
            { "text": "cleant", "isCorrect": false, "rationale": "Incorreto. Esta forma não existe. O passado é 'cleaned'." }
        ]
    },
    {
        "question": "26. You ______ soccer yesterday.",
        "topic": "Negative Form (didn't)",
        "hint": "Lembre-se da regra: não use o verbo com '-ed' depois de 'didn't'!",
        "options": [
            { "text": "didn't play", "isCorrect": true, "rationale": "Correto! A forma negativa é 'didn't' + a forma base do verbo ('play')." },
            { "text": "didn't played", "isCorrect": false, "rationale": "Incorreto. Este é um erro muito comum. O verbo volta ao normal após 'didn't'." },
            { "text": "not played", "isCorrect": false, "rationale": "Incorreto. Falta o auxiliar 'did'." },
            { "text": "don't play", "isCorrect": false, "rationale": "Incorreto. 'Don't' é para o presente." }
        ]
    },
    {
        "question": "27. ______ you ______ yesterday?",
        "topic": "Interrogative Form (Did)",
        "hint": "É uma pergunta sobre a ação 'cook' (cozinhar) no passado.",
        "options": [
            { "text": "Did / cook", "isCorrect": true, "rationale": "Correto! A pergunta inicia com 'Did' e o verbo 'cook' fica na forma base." },
            { "text": "Did / cooked", "isCorrect": false, "rationale": "Incorreto. O verbo não pode ter '-ed' quando 'Did' está na frase." },
            { "text": "Do / cook", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente." },
            { "text": "Cooked / you", "isCorrect": false, "rationale": "Incorreto. A estrutura da pergunta está errada." }
        ]
    },
    {
        "question": "28. He ______ me the truth.",
        "topic": "Affirmative - Irregular Verbs",
        "hint": "O passado do verbo irregular 'tell' (contar) é...",
        "options": [
            { "text": "told", "isCorrect": true, "rationale": "Correto! 'Told' é o passado irregular do verbo 'tell'." },
            { "text": "telled", "isCorrect": false, "rationale": "Incorreto. 'Tell' é um verbo irregular e não aceita '-ed'." },
            { "text": "did tell", "isCorrect": false, "rationale": "Incorreto. 'Did' não é usado em frases afirmativas." },
            { "text": "tells", "isCorrect": false, "rationale": "Incorreto. 'Tells' é a forma do presente para 'he/she/it'." }
        ]
    },
    {
        "question": "29. I opened the door, but I ______ anyone.",
        "topic": "Negative Form (didn't)",
        "hint": "A segunda parte da frase está na negativa. O verbo é 'see'.",
        "options": [
            { "text": "didn't see", "isCorrect": true, "rationale": "Correto! A negativa no passado é 'didn't' + verbo base 'see'." },
            { "text": "didn't saw", "isCorrect": false, "rationale": "Incorreto. Depois de 'didn't', o verbo deve voltar para 'see'." },
            { "text": "not see", "isCorrect": false, "rationale": "Incorreto. É necessário o auxiliar 'did'." },
            { "text": "saw not", "isCorrect": false, "rationale": "Incorreto. A estrutura está errada." }
        ]
    },
    {
        "question": "30. What ______ you eat for dinner last night?",
        "topic": "WH-Questions",
        "hint": "A estrutura é WH-word + auxiliar + sujeito + verbo.",
        "options": [
            { "text": "did", "isCorrect": true, "rationale": "Correto! O auxiliar 'did' é necessário para formar a pergunta no passado." },
            { "text": "do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente." },
            { "text": "ate", "isCorrect": false, "rationale": "Incorreto. O auxiliar 'did' precisa vir antes do sujeito 'you'." },
            { "text": "were", "isCorrect": false, "rationale": "Incorreto. 'Were' é o verbo 'to be', não o auxiliar para o verbo de ação 'eat'." }
                    ]
                }
            ],

            startQuiz(continueFromSavedState) {
                const studentCode = this.elements.studentCodeInput.value.trim().toUpperCase();
                const correctName = this.studentData[studentCode];

                if (!correctName) {
                    alert("Código de acesso inválido. Por favor, verifique e tente novamente.");
                    return;
                }

                this.validatedStudentCode = studentCode;
                this.validatedStudentName = correctName;

                if (continueFromSavedState) {
                    this.loadQuizState(this.validatedStudentCode);
                } else {
                    this.currentQuestionIndex = 0;
                    this.score = 0;
                    this.userAnswers = {};
                    this.skippedQuestions = [];
                    this.currentSkippedIndex = 0;
		    this.balanceCorrectAnswers();
                    localStorage.removeItem(`quizState_${this.validatedStudentCode}`);

                    this.shuffledQuestions = this.shuffleArray([...this.questions]);
                }

                const storageKey = `quiz_attempts_${this.validatedStudentCode}`;
                let attempts = parseInt(localStorage.getItem(storageKey) || 0);
                localStorage.setItem(storageKey, attempts + 1);

                this.elements.studentCodeInput.style.display = 'none';
                this.elements.startActionsDiv.style.display = 'none';
                this.elements.quizDescription.style.display = 'none';

                this.elements.personalizedWelcome.textContent = `Bem-vindo(a), ${this.validatedStudentName}! Boa sorte!`;
                this.elements.personalizedWelcome.style.display = 'block';

                setTimeout(() => {
                    this.elements.introCard.style.display = 'none';
                    this.elements.quizCard.style.display = 'flex';
                    this.displayQuestion();
                }, 3000);
            },

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            displayQuestion() {
                this.elements.performanceDisplay.style.display = 'none';
                let questionToDisplay;
                let currentQuestionNumber;
                this.elements.hintText.style.display = 'none';
                this.elements.summaryText.style.display = 'none';
                this.elements.summaryButton.style.display = 'none';

                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
                    const skippedIndex = this.skippedQuestions[this.currentSkippedIndex];
                    questionToDisplay = this.questions[skippedIndex]; 
                    currentQuestionNumber = `(Pulada) ${this.currentSkippedIndex + 1} de ${this.skippedQuestions.length}`;
                    this.elements.skipButton.style.display = 'none';
                    this.elements.nextButton.textContent = 'Próxima Questão';
                } else if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    questionToDisplay = this.shuffledQuestions[this.currentQuestionIndex];
                    currentQuestionNumber = this.currentQuestionIndex + 1;
                    this.elements.skipButton.style.display = 'inline-block';
                    this.elements.nextButton.textContent = 'Próxima Questão';
                } else {
                    this.showResults();
                    return;
                }

                this.elements.currentQuestionNumSpan.textContent = currentQuestionNumber;
                this.elements.nextButton.style.display = 'none';
                this.elements.optionsList.innerHTML = '';
                this.elements.questionText.textContent = questionToDisplay.question;

                questionToDisplay.options.forEach((option, index) => {
                    const li = document.createElement('li');
                    li.className = 'option-item';
                    li.textContent = option.text;
                    li.onclick = () => this.selectOption(li, option);
                    this.elements.optionsList.appendChild(li);
                });
            },

            selectOption(selectedElement, selectedOption) {
                const options = document.querySelectorAll('.option-item');

                options.forEach(option => {
                    option.style.pointerEvents = 'none';
                });

                const justificationElement = document.createElement('div');
                justificationElement.className = 'justification';

                let currentQuestion;
                let originalQuestionIndex;

                if (this.currentQuestionIndex >= this.shuffledQuestions.length) {
                    originalQuestionIndex = this.skippedQuestions[this.currentSkippedIndex];
                    currentQuestion = this.questions[originalQuestionIndex];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    originalQuestionIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
                }

                const correctOptions = currentQuestion.options.filter(opt => opt.isCorrect);
                const correctOptionTexts = correctOptions.map(opt => opt.text);
                const isCorrect = correctOptionTexts.includes(selectedOption.text);

                if (isCorrect) {
                    this.score++;
                    selectedElement.classList.add('correct');
                    justificationElement.textContent = selectedOption.rationale;
                    justificationElement.style.borderColor = '#28a745';
                    this.elements.summaryButton.style.display = 'none';
                } else {
                    selectedElement.classList.add('incorrect');
                    const correctElements = Array.from(options).filter(el => correctOptionTexts.includes(el.textContent));
                    correctElements.forEach(el => el.classList.add('correct'));
                    justificationElement.textContent = selectedOption.rationale;
                    justificationElement.style.borderColor = '#dc3545';
                    this.elements.summaryButton.style.display = 'inline-block';
                }

                this.userAnswers[originalQuestionIndex] = {
                    question: currentQuestion.question,
                    userAnswer: selectedOption.text,
                    isCorrect: isCorrect,
                    correctAnswer: correctOptionTexts.join(' ou '),
                    rationale: selectedOption.rationale
                };

                selectedElement.parentNode.insertBefore(justificationElement, selectedElement.nextSibling);
                justificationElement.style.display = 'block';

                this.elements.nextButton.style.display = 'block';
                this.elements.skipButton.style.display = 'none'; 
                this.saveQuizState();
            },

            showPerformance() {
                const answeredCount = Object.keys(this.userAnswers).length;
                const correctCount = this.score;
                const incorrectCount = answeredCount - correctCount;

                this.elements.performanceDisplay.innerHTML = `Até agora: <span style="color: #28a745;">${correctCount} acertos</span> e <span style="color: #dc3545;">${incorrectCount} erros</span>.`;
                this.elements.performanceDisplay.style.display = 'block';
            },
            
            showHint() {
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }

                if (currentQuestion && currentQuestion.hint) {
                    this.elements.hintText.textContent = currentQuestion.hint;
                    this.elements.hintText.style.display = 'block';
                }
            },

            showSummary() {
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }
                
                const questionTopic = currentQuestion.topic;

                if (questionTopic && this.summaries[questionTopic]) {
                    this.elements.summaryText.textContent = this.summaries[questionTopic];
                    this.elements.summaryText.style.display = 'block';
                }
            },

            nextQuestion() {
                if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    this.currentQuestionIndex++;
                } else {
                    this.currentSkippedIndex++;
                }
                
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.currentSkippedIndex >= this.skippedQuestions.length) {
                    this.showResults();
                } else {
                    this.displayQuestion();
                }
            },

            skipQuestion() {
                if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    const originalIndex = this.questions.findIndex(q => q.question === this.shuffledQuestions[this.currentQuestionIndex].question);
                    this.skippedQuestions.push(originalIndex);
                }
                this.currentQuestionIndex++;
                this.displayQuestion();
            },

            getClassification(percentage) {
                if (percentage >= 86) return "Excelente!!!";
                if (percentage >= 71) return "Muito Bom!!";
                if (percentage >= 51) return "Bom!";
                if (percentage >= 0) return "Insatisfatório!";
                return "Classificação não disponível";
            },

            launchConfetti() {
                confetti({ particleCount: 600, spread: 70, origin: { y: 0.6 } });
                setTimeout(() => confetti({ particleCount: 450, spread: 90, origin: { x: 0, y: 0.8 } }), 500);
                setTimeout(() => confetti({ particleCount: 450, spread: 90, origin: { x: 1, y: 0.8 } }), 800);
                setTimeout(() => confetti({ particleCount: 300, spread: 120, origin: { y: 0.2 } }), 1000);
            },

            showResults() {
                this.elements.quizCard.style.display = 'none';
                this.elements.resultsCard.style.display = 'block';
                this.elements.incorrectQuestionsContainer.innerHTML = '';
                this.elements.fullReportContainer.innerHTML = '';
                localStorage.removeItem(`quizState_${this.validatedStudentCode}`);

                const percentage = Math.round((this.score / this.questions.length) * 100);
                const classificationText = this.getClassification(percentage);

                this.elements.reportStudentName.textContent = this.validatedStudentName;
                this.elements.reportStudentCode.textContent = this.validatedStudentCode;
                this.elements.scoreDisplay.textContent = `${this.score} de ${this.questions.length}`;
                this.elements.percentageDisplay.textContent = `${percentage}%`;

                this.elements.classificationDisplay.textContent = classificationText;
                this.elements.classificationDisplay.classList.remove('classification-red', 'classification-blue', 'classification-orange');
                if (classificationText === "Insatisfatório!") {
                    this.elements.classificationDisplay.classList.add('classification-red');
                } else if (classificationText === "Excelente!!!") {
                    this.launchConfetti();
                    this.elements.classificationDisplay.classList.add('classification-orange');
                    setTimeout(() => {
                        this.elements.classificationDisplay.classList.remove('classification-orange');
                        this.elements.classificationDisplay.style.color = '#FFA500';
                        this.elements.classificationDisplay.style.fontWeight = 'bold';
                        this.elements.classificationDisplay.style.animation = 'none';
                    }, 5000);
                } else if (classificationText === "Muito Bom!!" || classificationText === "Bom!") {
                    this.elements.classificationDisplay.classList.add('classification-blue');
                }

                this.elements.fullReportContainer.innerHTML = this.generateFullReportHtml();
                this.elements.fullReportContainer.style.display = 'block';

                const shareMessage = this.generateShareMessage(percentage, classificationText);
                const encodedMessage = encodeURIComponent(shareMessage);
                this.elements.shareWhatsappLink.href = `https://wa.me/?text=${encodedMessage}`;

                const data = {
                    nome: this.validatedStudentName,
                    codigo: this.validatedStudentCode,
                    pontuacao: `${this.score} de ${this.questions.length}`,
                    percentual: `${percentage}%`,
                    classificacao: classificationText,
                };

                fetch(this.APP_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'no-cors'
                })
                .then(() => console.log('Dados enviados com sucesso para a planilha!'))
                .catch(error => console.error('Erro ao enviar dados:', error));

                this.elements.sendReportLink.textContent = 'Relatório Enviado!';
                this.elements.sendReportLink.href = '#';
                this.elements.sendReportLink.onclick = (e) => e.preventDefault();
                this.elements.sendReportLink.style.cursor = 'default';
                this.elements.sendReportLink.style.backgroundColor = '#ccc';
            },

            generateFullReportHtml() {
                let html = '<h3>Relatório Completo de Respostas:</h3>';
                this.questions.forEach((question, index) => {
                    const userAnswerObj = this.userAnswers[index] || {};
                    const userAnswerText = userAnswerObj.userAnswer;
                    const isCorrect = userAnswerObj.isCorrect;
                    
                    html += `<div class="report-question-item">`;
                    html += `<p><strong>Questão ${index + 1}:</strong> ${question.question}</p>`;
                    html += `<ul style="list-style-type: none; padding-left: 0;">`;

                    question.options.forEach(option => {
                        const isUserAnswer = (option.text === userAnswerText);
                        const isCorrectOption = option.isCorrect;

                        let optionClass = '';
                        if (isCorrectOption) {
                            optionClass = 'correct';
                        } else if (isUserAnswer) {
                            optionClass = 'incorrect';
                        }

                        let textPrefix = '';
                        if (isUserAnswer && isCorrectOption) {
                            textPrefix = 'Sua Resposta Correta: ';
                        } else if (isCorrectOption) {
                            textPrefix = 'Resposta Correta: ';
                        } else if (isUserAnswer) {
                            textPrefix = 'Sua Resposta: ';
                        }

                        html += `<li class="option-item-report ${optionClass}">`;
                        html += `<p><strong>${textPrefix}</strong>${option.text}</p>`;
                        html += `<div class="justification" style="display: block;">${option.rationale}</div>`;
                        html += `</li>`;
                    });

                    html += '</ul></div>';
                });
                return html;
            },

            generateShareMessage(percentage, classificationText) {
                let message = `*Relatório Completo do Quiz de Inglês*\n\n`;
                message += `*Aluno(a):* ${this.validatedStudentName}\n`;
                message += `*Código de Acesso:* ${this.validatedStudentCode}\n`;
                message += `*Pontuação:* ${this.score} de ${this.questions.length}\n`;
                message += `*Percentual de Acerto:* ${percentage}%\n`;
                message += `*Classificação:* ${classificationText}\n\n`;
                message += `*--- Respostas ---*\n`;

                this.questions.forEach((question, index) => {
                    const userAnswerObj = this.userAnswers[index] || {};
                    const userAnswerText = userAnswerObj.userAnswer || 'Não respondida';
                    const isCorrect = userAnswerObj.isCorrect;
                    const correctAnswer = question.options.find(opt => opt.isCorrect).text;
                    const rationale = userAnswerObj.rationale || question.options.find(opt => opt.isCorrect).rationale;

                    message += `\n*Questão ${index + 1}:* ${question.question}\n`;
                    message += `_Sua resposta:_ ${isCorrect ? `😄` : `😢`} ${userAnswerText}\n`;
                    message += `_Resposta correta:_ ${correctAnswer}\n`;
                    message += `_Justificativa:_ ${rationale}\n`;
                });
                return message;
            },

            saveQuizState() {
                const quizState = {
                    questionIndex: this.currentQuestionIndex,
                    userResponses: this.userAnswers,
                    studentCode: this.validatedStudentCode,
                    studentName: this.validatedStudentName,
                    skippedQuestions: this.skippedQuestions,
                    currentSkippedIndex: this.currentSkippedIndex,
                    shuffledQuestions: this.shuffledQuestions // Salva a ordem embaralhada
                };
                localStorage.setItem(`quizState_${this.validatedStudentCode}`, JSON.stringify(quizState));
            },

            loadQuizState(studentCode) {
                const savedState = localStorage.getItem(`quizState_${studentCode}`);
                if (savedState) {
                    const quizState = JSON.parse(savedState);
                    if (quizState.studentCode === studentCode) {
                        this.currentQuestionIndex = quizState.questionIndex;
                        this.score = quizState.score || Object.values(quizState.userResponses).filter(a => a.isCorrect).length;
                        this.userAnswers = quizState.userResponses || {};
                        this.validatedStudentName = quizState.studentName;
                        this.validatedStudentCode = quizState.studentCode;
                        this.skippedQuestions = quizState.skippedQuestions || [];
                        this.currentSkippedIndex = quizState.currentSkippedIndex || 0;
                        this.shuffledQuestions = quizState.shuffledQuestions;
                        return true;
                    }
                }
                return false;
            },

            updateAttemptsDisplay(code) {
                this.elements.attemptsLeftSpan.textContent = "Ilimitadas";
                this.elements.introAttemptsLeftSpan.textContent = "ilimitadas";
                this.elements.startActionsDiv.innerHTML = '';
                
                if (this.loadQuizState(code)) {
                    const continueBtn = document.createElement('button');
                    continueBtn.textContent = 'Continuar Quiz';
                    continueBtn.className = 'start-btn continue-btn';
                    continueBtn.onclick = () => this.startQuiz(true);
                    this.elements.startActionsDiv.appendChild(continueBtn);

                    const newBtn = document.createElement('button');
                    newBtn.textContent = 'Iniciar Novo Quiz';
                    newBtn.className = 'start-btn';
                    newBtn.style.backgroundColor = '#dc3545';
                    newBtn.onclick = () => {
                        if (confirm("Você tem um progresso salvo. Deseja realmente começar um novo quiz e perder o progresso atual?")) {
                            this.startQuiz(false);
                        }
                    };
                    this.elements.startActionsDiv.appendChild(newBtn);
                } else {
                    const startBtn = document.createElement('button');
                    startBtn.textContent = 'Start Quiz';
                    startBtn.className = 'start-btn';
                    startBtn.onclick = () => this.startQuiz(false);
                    this.elements.startActionsDiv.appendChild(startBtn);
                }
            },

            restartQuiz() {
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.userAnswers = {};
                this.skippedQuestions = [];
                this.currentSkippedIndex = 0;

                const studentCode = this.elements.studentCodeInput.value.trim().toUpperCase();
                if (studentCode) {
                    localStorage.removeItem(`quizState_${studentCode}`);
                }

                this.elements.resultsCard.style.display = 'none';
                this.elements.quizCard.style.display = 'none';
                this.elements.introCard.style.display = 'flex';
                this.elements.studentCodeInput.value = '';
                this.elements.studentCodeInput.style.display = 'block';
                this.elements.personalizedWelcome.style.display = 'none';
                this.elements.quizDescription.style.display = 'block';
                this.elements.sendReportLink.textContent = 'Enviar Relatório ao Professor';
                this.elements.sendReportLink.href = '#';
                this.elements.sendReportLink.onclick = null;
                this.elements.sendReportLink.style.cursor = 'pointer';
                this.elements.sendReportLink.style.backgroundColor = '#6c757d';

                this.elements.startActionsDiv.innerHTML = '<button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>';
                this.elements.startActionsDiv.style.display = 'block';
            },

            saveReport() {
                const scoreText = this.elements.scoreDisplay.textContent;
                const percentage = Math.round((this.score / this.questions.length) * 100);
                const classificationText = this.elements.classificationDisplay.textContent;

                let reportContent = `Relatório Completo do Quiz de Inglês\n\n`;
                reportContent += `Nome: ${this.validatedStudentName}\n`;
                reportContent += `Código de Acesso: ${this.validatedStudentCode}\n`;
                reportContent += `Pontuação: ${scoreText}\n`;
                reportContent += `Percentual de Acerto: ${percentage}%\n`;
                reportContent += `Classificação: ${classificationText}\n\n`;
                reportContent += `--- Respostas ---\n`;

                this.questions.forEach((question, index) => {
                    const userAnswerObj = this.userAnswers[index] || {};
                    const userAnswerText = userAnswerObj.userAnswer || 'Não respondida';
                    const isCorrect = userAnswerObj.isCorrect;
                    const correctAnswer = question.options.find(opt => opt.isCorrect).text;
                    const rationale = userAnswerObj.rationale || question.options.find(opt => opt.isCorrect).rationale;

                    reportContent += `\nQuestão ${index + 1}: ${question.question}\n`;
                    reportContent += `Sua resposta: ${isCorrect ? `(CORRETA) ` : `(INCORRETA) `}${userAnswerText}\n`;
                    reportContent += `Resposta correta: ${correctAnswer}\n`;
                    reportContent += `Justificativa: ${rationale}\n`;
                });

                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Relatorio-Quiz-${this.validatedStudentName.replace(/ /g, '-')}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            printReport() {
                window.print();
            },

            init() {
                this.elements.studentCodeInput.addEventListener('input', (e) => {
                    e.target.value = e.target.value.toUpperCase();
                    const code = e.target.value.trim().toUpperCase();
                    if (this.studentData[code]) {
                        this.updateAttemptsDisplay(code);
                    } else {
                        this.elements.startActionsDiv.innerHTML = '<button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>';
                    }
                });

                this.elements.performanceButton.onclick = () => this.showPerformance();
                this.elements.nextButton.onclick = () => this.nextQuestion();
                this.elements.skipButton.onclick = () => this.skipQuestion(); // Nova função
                //this.elements.restartBtn.onclick = () => this.restartQuiz();
                //this.elements.saveReportBtn.onclick = () => this.saveReport();
                //this.elements.printBtn.onclick = () => this.printReport();

                const code = this.elements.studentCodeInput.value.trim().toUpperCase();
                if (this.studentData[code]) {
                    this.updateAttemptsDisplay(code);
                } else {
                    this.restartQuiz();
                }
            }
        };

        window.onload = function() {
            quizApp.init();
        };

    </script>
</body>

</html>
