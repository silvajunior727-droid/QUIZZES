<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REVISÃO - CONDICIONAL SIMPLES!!!</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px;
            min-height: 400px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #dc3545; /* Alterado para vermelho */
        }
        
        h2 {
            text-align: center;
            color: #444;
        }

        .question-card, .results-card, .intro-card {
            display: none;
            flex-direction: column;
        }

        .intro-card {
            display: flex;
            text-align: center;
        }

        .intro-card input {
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .option-item {
            background-color: #e9ecef;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        .option-item:hover {
            background-color: #d1e7dd;
        }

        .option-item.correct {
            background-color: #28a745;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }

        .option-item.incorrect {
            background-color: #dc3545;
            color: white;
            animation: shake 0.5s ease-in-out;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
        }

        .justification {
            margin-top: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 5px solid #007bff;
            border-radius: 5px;
            display: none;
        }

        .feedback {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }

        .feedback.correct-text {
            color: #28a745;
        }

        .feedback.incorrect-text {
            color: #dc3545;
        }

        .next-btn, .skip-btn, .hint-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            display: none;
            float: right;
            margin-left: 10px;
        }

        .skip-btn {
            background-color: #ffc107;
            color: #333;
        }

        .hint-btn {
            background-color: #6a0dad; /* Cor roxa para o botão Dica */
            display: inline-block;
            float: none;
        }

        .hint-text {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-left: 5px solid #6c757d;
            border-radius: 5px;
            font-style: italic;
            display: none;
        }

        .question-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap; /* Permite que os itens quebrem linha */
        }
        
        .start-btn, .restart-btn, .send-report-btn, .print-btn, .share-btn, .save-report-btn, .continue-btn {
            display: inline-block;
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
            animation: pulse 2s infinite;
        }

        .restart-btn {
            background-color: #dc3545;
        }

        .send-report-btn {
            background-color: #6c757d;
        }

        .print-btn {
            background-color: #007bff;
        }

        .results-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .share-btn {
            background-color: #25d366;
        }

        .share-btn img {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }

        .save-report-btn {
            background-color: #007bff;
        }

        .results-card h2 {
            margin-bottom: 20px;
        }

        .results-card p {
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .results-card .score-display {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-top: 10px;
        }

        .attempts-counter {
            text-align: right;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }

        .question-counter {
            text-align: left;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }

        .incorrect-questions-list {
            margin-top: 30px;
            border-top: 2px solid #ccc;
            padding-top: 20px;
        }

        .full-report-list {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ccc;
        }

        .incorrect-questions-list h3, .full-report-list h3 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .full-report-list h3 {
            color: #007bff;
        }

        .incorrect-question-item, .report-question-item {
            background-color: #fff3f3;
            border: 1px solid #f5c6cb;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .report-question-item {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
        }

        .incorrect-question-item p, .report-question-item p {
            margin: 5px 0;
        }

        .incorrect-question-item p strong, .report-question-item p strong {
            color: #333;
        }

        .incorrect-question-item .justification, .report-question-item .justification {
            background-color: #f8d7da;
            border-left: 5px solid #dc3545;
        }

        .report-question-item .option-item-report {
            background-color: #e9ecef;
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
        }

        .report-question-item .option-item-report.correct {
            background-color: #d4edda;
        }

        .report-question-item .option-item-report.incorrect {
            background-color: #f8d7da;
        }

        .classification-red {
            color: red;
        }

        .classification-blue {
            color: #007bff;
        }

        .classification-orange {
            color: #FFA500;
            font-weight: bold;
            animation: blink-text 1s linear infinite;
        }

        .performance-btn {
            background-color: #FFA500; /* Laranja */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            margin-left: 0; /* Ajustado para alinhar corretamente com flexbox */
            margin-right: auto; /* Empurra os outros botões para a direita */
        }

        .performance-display {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            border-radius: 5px;
            font-weight: bold;
            color: #856404;
            text-align: left;
        }

        @keyframes blink-text {
            50% {
                opacity: 0;
            }
        }

        /* Estilos específicos para impressão */
        @media print {
            body {
                background-color: #fff;
                padding-top: 0;
                display: block;
            }

            .container {
                box-shadow: none;
                border: none;
                width: 100%;
                max-width: none;
                min-height: auto;
            }

            #intro-card, #quiz-card, .results-actions, .print-btn, .attempts-counter, .question-counter {
                display: none !important;
            }

            #results-card {
                display: block !important;
            }

            .incorrect-questions-list, .full-report-list {
                display: block !important;
                border-top: 1px solid #ccc;
                padding-top: 10px;
            }

            .incorrect-question-item, .report-question-item {
                margin-bottom: 10px;
                border: 1px solid #ddd;
                background-color: #f9f9f9;
            }

            .report-question-item .justification {
                display: block !important;
                padding: 10px;
                margin-top: 5px;
                border-left: 3px solid #eee;
                background-color: #eee;
                font-size: 0.9em;
            }

            .report-question-item .option-item-report {
                margin: 3px 0;
                padding: 5px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="intro-card" class="intro-card">
            <h1>English Grammar Quiz</h1>
            <h2>REVISÃO CONDICIONAL SIMPLES</h2>
            <p id="personalized-welcome" style="font-size: 1.2rem; font-weight: bold; margin-top: 10px; display: none;">Seja bem-vindo(a) e boa sorte!</p>
            <p id="quiz-description">Por favor, insira seu código de acesso para iniciar o teste. Ele tem 30 questões. Você tem tentativas <span id="intro-attempts-left">ilimitadas</span> para fazer este teste.</p>
            <input type="text" id="student-code" placeholder="Your Access Code!">
            <div id="start-actions">
                <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
            </div>
        </div>

        <div id="quiz-card" class="question-card">
            <div class="attempts-counter">Tentativas restantes: <span id="attempts-left">Ilimitadas</span></div>
            <div class="question-counter">Questão <span id="current-question-num">1</span> de 30</div>
            <div id="question-text" class="question-text"></div>
            <ul id="options-list" class="options-list"></ul>
            <div id="hint-container">
                <button id="hint-button" class="hint-btn" onclick="quizApp.showHint()">Dica</button>
                <div id="hint-text" class="hint-text"></div>
                <div id="summary-text" class="hint-text" style="border-left-color: #28a745;"></div>
            </div>
            <div class="question-actions">
                <button id="performance-btn" class="performance-btn">DESEMPENHO</button>
                <button id="summary-button" class="start-btn" onclick="quizApp.showSummary()" style="background-color: #28a745; display: none;">Resumo</button>
                <button id="skip-button" class="skip-btn" onclick="quizApp.skipQuestion()">Pular Questão</button>
                <button id="next-button" class="next-btn" onclick="quizApp.nextQuestion()">Próxima Questão</button>
                <div id="performance-display" class="performance-display" style="display: none;"></div>
            </div>
        </div>

        <div id="results-card" class="results-card">
            <h1>Relatório Final</h1>
            <p><strong>Nome:</strong> <span id="report-student-name"></span></p>
            <p><strong>Código de Acesso:</strong> <span id="report-student-code"></span></p>
            <p><strong>Pontuação:</strong> <span id="score-display"></span></p>
            <p><strong>Percentual de Acerto:</strong> <span id="percentage-display"></span></p>
            <p><strong>Classificação:</strong> <span id="classification-display"></span></p>
            <div class="results-actions">
                <a id="send-report-link" class="send-report-btn" href="#" target="_blank">Enviar Relatório ao Professor</a>
                <button class="restart-btn" onclick="quizApp.restartQuiz()">Reiniciar Teste</button>
                <a id="share-whatsapp" class="start-btn share-btn" href="#" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"> Compartilhar
                </a>
                <button class="start-btn save-report-btn" onclick="quizApp.saveReport()">Salvar Relatório</button>
                <button class="start-btn print-btn" onclick="quizApp.printReport()">Imprimir Relatório</button>
            </div>
            <div id="incorrect-questions-container" class="incorrect-questions-list"></div>
            <div id="full-report-container" class="full-report-list" style="display: none;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

    <script>
        const quizApp = {
            // SUBSTITUA A URL ABAIXO PELA URL DO SEU PRÓPRIO GOOGLE SCRIPT.
            APP_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwtDAlCCBcc3cN3pHX5YTvCZBsYTH--UJbeaczv64av_vIkybVIaEs-nTLKM2ssHND2/exec',
            
            currentQuestionIndex: 0,
            score: 0,
            userAnswers: {},
            validatedStudentName: '',
            validatedStudentCode: '',
            totalAttempts: "Ilimitadas",
            skippedQuestions: [], // Nova propriedade para armazenar questões puladas
            currentSkippedIndex: 0, // Nova propriedade para rastrear o índice das questões puladas
            
            // Elementos DOM
            elements: {
                studentCodeInput: document.getElementById('student-code'),
                introCard: document.getElementById('intro-card'),
                quizCard: document.getElementById('quiz-card'),
                resultsCard: document.getElementById('results-card'),
                questionText: document.getElementById('question-text'),
                optionsList: document.getElementById('options-list'),
                nextButton: document.getElementById('next-button'),
                skipButton: document.getElementById('skip-button'), // Novo elemento
                hintButton: document.getElementById('hint-button'),
                hintText: document.getElementById('hint-text'),
                attemptsLeftSpan: document.getElementById('attempts-left'),
                currentQuestionNumSpan: document.getElementById('current-question-num'),
                scoreDisplay: document.getElementById('score-display'),
                percentageDisplay: document.getElementById('percentage-display'),
                classificationDisplay: document.getElementById('classification-display'),
                reportStudentName: document.getElementById('report-student-name'),
                reportStudentCode: document.getElementById('report-student-code'),
                sendReportLink: document.getElementById('send-report-link'),
                introAttemptsLeftSpan: document.getElementById('intro-attempts-left'),
                incorrectQuestionsContainer: document.getElementById('incorrect-questions-container'),
                fullReportContainer: document.getElementById('full-report-container'),
                shareWhatsappLink: document.getElementById('share-whatsapp'),
                personalizedWelcome: document.getElementById('personalized-welcome'),
                startActionsDiv: document.getElementById('start-actions'),
                quizDescription: document.getElementById('quiz-description'),
                summaryButton: document.getElementById('summary-button'),
                summaryText: document.getElementById('summary-text'),
                performanceButton: document.getElementById('performance-btn'),
                performanceDisplay: document.getElementById('performance-display')
            },

            studentData: {
                "001AB": "ELMA", "002CD": "GUSTAVO", "003EF": "PIETRA", "004GH": "GEOVANNA", "005IJ": "LEOZINHO",
                "006KL": "MARIANA", "007MN": "NICOLAS", "008OP": "YAGO", "009QR": "CAIO", "010ST": "GIH",
                "011UV": "LUCAS RESENDE", "012WX": "BRUNA", "013YZ": "DIMI", "014AB": "FABRÍCIO", "015CD": "MIGUEL",
                "016EF": "YAGO", "017GH": "ANDRÉIA", "018IJ": "KAUÃ", "019KL": "PABLO", "020MN": "SURY",
                "021OP": "TAINÁ", "022QR": "YASMIN", "023ST": "MÁRCIA", "024UV": "RICK", "025WX": "ROSA",
                "026YZ": "FÁTIMA", "027AB": "LUCA", "028CD": "ALEX", "029EF": "DÉBORA", "030GH": "GIOVANNA",
                "031IJ": "PÂMELA", "032KL": "YASMIN", "033MN": "ADRIANO", "034OP": "ARTHUR", "035QR": "YASMIN",
                "036ST": "DAVI", "037UV": "DEREK", "038WX": "PEDRINHO", "039YZ": "DENILSON", "040AB": "EDSON",
                "041CD": "ALÍCIA", "042EF": "CAROLINA", "043GH": "ELSON", "044IJ": "LETÍCIA", "045KL": "DIEGO",
                "046MN": "GABI", "047OP": "KIM", "048QR": "LANA", "049ST": "MANU", "050UV": "SABRINA",
                "051WX": "BRUNA", "052YZ": "DIMI", "053AB": "FABRÍCIO", "054CD": "MIGUEL", "055EF": "YAGO",
                "056GH": "ANDRÉIA", "057IJ": "KAUÃ", "058KL": "PABLO", "059MN": "SURY", "060OP": "TAINÁ",
                "061QR": "YASMIN", "062ST": "MÁRCIA", "063UV": "RICK", "064WX": "ROSA", "065YZ": "FÁTIMA",
                "066AB": "LUCA", "067CD": "ALEX", "JR123": "JÚNIOR", "068EF": "DÉBORA", "069GH": "GIOVANNA", "070IJ": "PÂMELA",
                "071KL": "YASMIN", "072MN": "ADRIANO", "073OP": "ARTHUR", "074QR": "YASMIN", "075ST": "DAVI",
                "076UV": "DEREK", "077WX": "PEDRINHO", "078YZ": "DENILSON", "079AB": "EDSON", "080CD": "ALÍCIA",
                "081EF": "CAROLINA", "082GH": "ELSON", "083IJ": "LETÍCIA", "084KL": "DIEGO", "085MN": "GABI",
                "086OP": "KIM", "087QR": "LANA", "088ST": "MANU", "089UV": "SABRINA", "090WX": "DIMI", "101QR": "ANA CLARA", "102ST": "JOAQUIM",
                "091YZ": "FABRÍCIO", "092AB": "MIGUEL", "093CD": "YAGO", "094EF": "ANDRÉIA", "095GH": "KAUÃ",
                "096IJ": "PABLO", "097KL": "SURY", "098MN": "TAINÁ", "099OP": "YASMIN", "100QR": "MÁRCIA", "101ST": "MONIQUE", "102UV": "VICTOR"
            },
            
            summaries: {
                "General Use": "O Condicional Simples usa 'would' para expressar situações hipotéticas, desejos, pedidos educados e conselhos.",
                "Affirmative Form": "A estrutura é: Sujeito + would + verbo na forma base. Ex: I would go.",
                "Negative Form": "A forma negativa é: Sujeito + would not (ou a contração wouldn't) + verbo na forma base. Ex: He wouldn't know.",
                "Interrogative Form": "Para perguntas e pedidos, a estrutura é: Would + sujeito + verbo na forma base? Ex: Would you help?",
                "Second Conditional": "É muito usado com 'if' para situações imaginárias: If + Passado Simples, ... would + verbo base. Ex: If I knew, I would tell you."
            },
// --- INÍCIO DO CÓDIGO DE BALANCEAMENTO DE ALTERNATIVAS ---

            // Função utilitária para embaralhar um array (Algoritmo Fisher-Yates)
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            },

            // Função principal para forçar a distribuição uniforme das respostas corretas
            balanceCorrectAnswers() {
                const totalQuestions = this.questions.length;
                if (totalQuestions === 0) return;

                const numPositions = 4; // A, B, C, D
                
                // 1. Embaralha a ordem desejada para as posições [0, 1, 2, 3] entre as 40 questões.
                let desiredPositions = [];
                for (let i = 0; i < totalQuestions; i++) {
                    desiredPositions.push(i % numPositions);
                }
                this.shuffleArray(desiredPositions);
                
                // 2. Itera sobre cada questão para garantir o rebalanceamento.
                this.questions.forEach((q, index) => {
                    // Primeiro, embaralha as opções da questão para que a alternativa correta não
                    // fique sempre na mesma posição do código original.
                    this.shuffleArray(q.options);
                    
                    // Encontra a opção correta e a posição alvo
                    const correctOption = q.options.find(opt => opt.isCorrect);
                    if (!correctOption) return; // Segurança caso não haja resposta correta
                    
                    const targetIndex = desiredPositions[index]; // Posição alvo (0, 1, 2 ou 3)

                    // Se a resposta correta já estiver na posição alvo, não faz nada.
                    if (q.options[targetIndex] === correctOption) {
                        return;
                    }

                    // Remove a resposta correta da sua posição atual
                    const currentIndex = q.options.indexOf(correctOption);
                    q.options.splice(currentIndex, 1);
                    
                    // Insere a resposta correta na posição alvo (forçando o balanceamento)
                    q.options.splice(targetIndex, 0, correctOption);
                });

                console.log("Alternativas corretas rebalanceadas para 10 em cada posição (0, 1, 2, 3).");
            },

// --- FIM DO CÓDIGO DE BALANCEAMENTO DE ALTERNATIVAS ---
  "questions": [
    {
        "question": "1. If I had more money, I ______ a new car.",
        "topic": "Second Conditional",
        "hint": "Esta é uma situação hipotética (Se eu tivesse...). Qual auxiliar usamos para a consequência imaginária?",
        "options": [
            { "text": "would buy", "isCorrect": true, "rationale": "Correto! Usamos 'would' + verbo base para descrever o resultado de uma condição hipotética." },
            { "text": "will buy", "isCorrect": false, "rationale": "Incorreto. 'Will' é para situações reais no futuro. Aqui, a condição ('If I had') é imaginária." },
            { "text": "bought", "isCorrect": false, "rationale": "Incorreto. 'Bought' é o passado simples." },
            { "text": "buy", "isCorrect": false, "rationale": "Incorreto. Falta o auxiliar 'would' para expressar a condição." }
        ]
    },
    {
        "question": "2. I ______ love to visit Paris one day.",
        "topic": "General Use",
        "hint": "Esta frase expressa um desejo ou uma preferência.",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! A expressão 'I would love to...' é muito comum para falar de desejos." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. 'Will' expressa um plano mais concreto. 'Would' é melhor para um desejo." },
            { "text": "did", "isCorrect": false, "rationale": "Incorreto. 'Did' é o auxiliar do passado." },
            { "text": "am", "isCorrect": false, "rationale": "Incorreto. A estrutura 'I am love' está incorreta." }
        ]
    },
    {
        "question": "3. She ______ go there at night. It's too dangerous.",
        "topic": "Negative Form",
        "hint": "Como formamos a negativa de 'would'?",
        "options": [
            { "text": "wouldn't", "isCorrect": true, "rationale": "Correto! 'Wouldn't' (would not) é usado para expressar que uma ação hipotética não aconteceria." },
            { "text": "won't", "isCorrect": false, "rationale": "Incorreto. 'Won't' (will not) é para o futuro real, não para uma situação condicional ou de conselho." },
            { "text": "didn't", "isCorrect": false, "rationale": "Incorreto. 'Didn't' é para o passado." },
            { "text": "not would", "isCorrect": false, "rationale": "Incorreto. A palavra 'not' vem depois de 'would', formando 'would not' ou 'wouldn't'." }
        ]
    },
    {
        "question": "4. ______ you please open the window?",
        "topic": "Interrogative Form",
        "hint": "Esta é uma forma educada de fazer um pedido.",
        "options": [
            { "text": "Would", "isCorrect": true, "rationale": "Correto! Usamos 'Would you...?' para fazer pedidos de forma educada." },
            { "text": "Will", "isCorrect": false, "rationale": "Incorreto. 'Will' também pode ser usado, mas 'Would' é considerado mais polido e cortês." },
            { "text": "Do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente simples." },
            { "text": "Can", "isCorrect": false, "rationale": "Incorreto. 'Can' é possível, mas 'Would' é a forma mais educada que estamos estudando aqui." }
        ]
    },
    {
        "question": "5. He would ______ you, but he lost his phone.",
        "topic": "Affirmative Form",
        "hint": "Qual é a regra para o verbo que vem depois de 'would'?",
        "options": [
            { "text": "call", "isCorrect": true, "rationale": "Correto! Após 'would', o verbo principal (call) deve estar sempre em sua forma base." },
            { "text": "calls", "isCorrect": false, "rationale": "Incorreto. Nunca adicionamos '-s' ao verbo depois de 'would'." },
            { "text": "called", "isCorrect": false, "rationale": "Incorreto. O verbo deve estar na forma base, não no passado." },
            { "text": "to call", "isCorrect": false, "rationale": "Incorreto. Não usamos 'to' entre 'would' e o verbo principal." }
        ]
    },
    {
        "question": "6. What ______ you do if you were me?",
        "topic": "Interrogative Form",
        "hint": "Uma pergunta hipotética sobre o que a outra pessoa faria.",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! A estrutura é 'What + would + sujeito + verbo base'." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. 'Will' seria para uma situação futura real, não imaginária ('if you were me')." },
            { "text": "did", "isCorrect": false, "rationale": "Incorreto. 'Did' é para o passado." },
            { "text": "do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente." }
        ]
    },
    {
        "question": "7. They ______ travel more if they had the time.",
        "topic": "Second Conditional",
        "hint": "A condição 'se eles tivessem tempo' é imaginária. Qual é a consequência?",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! A estrutura do second conditional é 'if + passado, ... would + verbo base'." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. A condição é hipotética ('if they had'), então usamos 'would'." },
            { "text": "traveled", "isCorrect": false, "rationale": "Incorreto. Falta o auxiliar 'would'." },
            { "text": "wouldn't", "isCorrect": false, "rationale": "Incorreto. A frase sugere que eles viajariam, então a forma afirmativa é a correta." }
        ]
    },
    {
        "question": "8. She said she ______ come to the meeting.",
        "topic": "General Use",
        "hint": "Isso é 'futuro do pretérito' em português ('ela disse que viria').",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! Usamos 'would' para descrever uma ação futura a partir de um ponto de vista no passado ('she said')." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. Se ela dissesse agora, seria 'She says she will come'. Como ela já disse ('said'), usamos 'would'." },
            { "text": "can", "isCorrect": false, "rationale": "Incorreto. 'Can' expressa habilidade." },
            { "text": "is", "isCorrect": false, "rationale": "Incorreto. A estrutura está errada." }
        ]
    },
    {
        "question": "9. I ______ do that if I were you.",
        "topic": "Negative Form",
        "hint": "A pessoa está dando um conselho negativo ('Eu não faria isso...').",
        "options": [
            { "text": "wouldn't", "isCorrect": true, "rationale": "Correto! 'Wouldn't' é usado para dar conselhos na forma negativa." },
            { "text": "would", "isCorrect": false, "rationale": "Incorreto. 'I would do that' seria um conselho para fazer a ação." },
            { "text": "won't", "isCorrect": false, "rationale": "Incorreto. 'Won't' é para o futuro, não para dar um conselho hipotético." },
            { "text": "couldn't", "isCorrect": false, "rationale": "Incorreto. 'Couldn't' significa 'não poderia' (falta de habilidade), enquanto 'wouldn't' significa 'não faria' (escolha)." }
        ]
    },
    {
        "question": "10. ______ he accept the offer if we made one?",
        "topic": "Interrogative Form",
        "hint": "Como iniciamos uma pergunta sobre uma situação hipotética?",
        "options": [
            { "text": "Would", "isCorrect": true, "rationale": "Correto! Perguntas condicionais são iniciadas com 'Would'." },
            { "text": "Will", "isCorrect": false, "rationale": "Incorreto. 'Will' é para o futuro certo ou provável." },
            { "text": "Did", "isCorrect": false, "rationale": "Incorreto. 'Did' é para o passado." },
            { "text": "Does", "isCorrect": false, "rationale": "Incorreto. 'Does' é para o presente." }
        ]
    },
    {
        "question": "11. We ______ worry about that. It's not our problem.",
        "topic": "Negative Form",
        "hint": "Nós 'não nos preocuparíamos'. Como expressar isso?",
        "options": [
            { "text": "wouldn't", "isCorrect": true, "rationale": "Correto! 'Wouldn't' indica que, na opinião do falante, não há razão para se preocupar." },
            { "text": "would", "isCorrect": false, "rationale": "Incorreto. Isso significaria 'nós nos preocuparíamos', o que contradiz o resto da frase." },
            { "text": "didn't", "isCorrect": false, "rationale": "Incorreto. 'Didn't' é passado." },
            { "text": "don't", "isCorrect": false, "rationale": "Incorreto. 'Don't' é presente." }
        ]
    },
    {
        "question": "12. If she knew the answer, she ______ you.",
        "topic": "Second Conditional",
        "hint": "A primeira parte é 'se ela soubesse'. A segunda parte é a consequência.",
        "options": [
            { "text": "would tell", "isCorrect": true, "rationale": "Correto! A estrutura 'If + Past, would + verb' é usada para o second conditional." },
            { "text": "will tell", "isCorrect": false, "rationale": "Incorreto. A condição ('If she knew') é irreal, então usamos 'would'." },
            { "text": "told", "isCorrect": false, "rationale": "Incorreto. Falta o auxiliar 'would'." },
            { "text": "would tells", "isCorrect": false, "rationale": "Incorreto. O verbo depois de 'would' nunca leva '-s'." }
        ]
    },
    {
        "question": "13. ______ you like some coffee?",
        "topic": "Interrogative Form",
        "hint": "Esta é uma maneira educada de oferecer algo a alguém.",
        "options": [
            { "text": "Would", "isCorrect": true, "rationale": "Correto! 'Would you like...?' é a forma padrão e educada de fazer uma oferta." },
            { "text": "Do", "isCorrect": false, "rationale": "Incorreto. 'Do you like coffee?' pergunta sobre a preferência geral da pessoa, não é uma oferta." },
            { "text": "Will", "isCorrect": false, "rationale": "Incorreto. Não usamos 'Will' para este tipo de oferta." },
            { "text": "Are", "isCorrect": false, "rationale": "Incorreto. 'Are' é o verbo 'to be'." }
        ]
    },
    {
        "question": "14. He ______ like that movie; it's not his style.",
        "topic": "Negative Form",
        "hint": "A segunda parte da frase ('não é o estilo dele') justifica uma opinião negativa.",
        "options": [
            { "text": "wouldn't", "isCorrect": true, "rationale": "Correto! 'Wouldn't' expressa uma opinião ou previsão sobre a preferência de alguém." },
            { "text": "would", "isCorrect": false, "rationale": "Incorreto. Isso contradiria a justificativa." },
            { "text": "won't", "isCorrect": false, "rationale": "Incorreto. 'Won't' seria para o futuro, mas aqui é uma suposição." },
            { "text": "doesn't", "isCorrect": false, "rationale": "Incorreto. 'He doesn't like' expressa um fato. 'He wouldn't like' expressa uma suposição." }
        ]
    },
    {
        "question": "15. Where ______ she live if she moved to Canada?",
        "topic": "Interrogative Form",
        "hint": "Uma pergunta com 'Where' sobre uma situação hipotética.",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! A estrutura é 'Where + would + sujeito + verbo base'." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. A condição ('if she moved') torna a situação imaginária, pedindo 'would'." },
            { "text": "did", "isCorrect": false, "rationale": "Incorreto. 'Did' é passado." },
            { "text": "does", "isCorrect": false, "rationale": "Incorreto. 'Does' é presente." }
        ]
    },
    {
        "question": "16. I ______ go, but I'm too busy.",
        "topic": "Affirmative Form",
        "hint": "A pessoa expressa uma vontade que não pode ser realizada.",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! 'I would go' (Eu iria) expressa a vontade, e 'but I'm too busy' explica por que não é possível." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. 'I will go' (Eu irei) é uma afirmação forte, que é contradita pela segunda parte da frase." },
            { "text": "went", "isCorrect": false, "rationale": "Incorreto. 'Went' é passado." },
            { "text": "am", "isCorrect": false, "rationale": "Incorreto. A estrutura 'I am go' está incorreta." }
        ]
    },
    {
        "question": "17. ______ they play in the snow if it was cold enough?",
        "topic": "Interrogative Form",
        "hint": "Uma pergunta sobre o que eles fariam sob uma certa condição.",
        "options": [
            { "text": "Would", "isCorrect": true, "rationale": "Correto! Usamos 'Would' para iniciar perguntas condicionais." },
            { "text": "Will", "isCorrect": false, "rationale": "Incorreto. 'Will' é para o futuro real." },
            { "text": "Did", "isCorrect": false, "rationale": "Incorreto. 'Did' é para o passado." },
            { "text": "Do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente." }
        ]
    },
    {
        "question": "18. If you studied harder, you ______ get better grades.",
        "topic": "Second Conditional",
        "hint": "Um conselho dado através de uma frase condicional.",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! Esta é a estrutura clássica do second conditional, usada para dar conselhos." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. A condição ('If you studied') é apresentada como hipotética, então a consequência usa 'would'." },
            { "text": "can", "isCorrect": false, "rationale": "Incorreto. 'Can' (pode) fala de habilidade. 'Would' (conseguiria) fala do resultado da condição." },
            { "text": "got", "isCorrect": false, "rationale": "Incorreto. Falta o auxiliar 'would'." }
        ]
    },
    {
        "question": "19. Why ______ she leave her job? It's a great job!",
        "topic": "Interrogative Form",
        "hint": "A pessoa está imaginando as razões para uma ação hipotética.",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! A pergunta explora uma possibilidade, não um fato. 'Por que ela deixaria o emprego?'" },
            { "text": "did", "isCorrect": false, "rationale": "Incorreto. 'Why did she leave?' significa que ela JÁ deixou o emprego." },
            { "text": "does", "isCorrect": false, "rationale": "Incorreto. 'Why does she leave?' não soa natural; seria melhor 'Why is she leaving?'." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. 'Why will she leave?' pergunta sobre um plano futuro confirmado." }
        ]
    },
    {
        "question": "20. He ______ that. He is a very honest person.",
        "topic": "Negative Form",
        "hint": "A frase expressa que, devido ao caráter dele, ele não faria algo.",
        "options": [
            { "text": "wouldn't do", "isCorrect": true, "rationale": "Correto! 'Wouldn't do' expressa uma forte crença de que ele não realizaria a ação." },
            { "text": "would do", "isCorrect": false, "rationale": "Incorreto. Isso contradiz a ideia de que ele é uma pessoa honesta." },
            { "text": "didn't do", "isCorrect": false, "rationale": "Incorreto. 'Didn't do' afirma que ele não fez algo no passado, enquanto 'wouldn't do' fala sobre seu caráter em geral." },
            { "text": "won't do", "isCorrect": false, "rationale": "Incorreto. 'Won't do' é uma recusa no futuro." }
        ]
    },
    {
        "question": "21. What ______ you say if you were asked?",
        "topic": "Interrogative Form",
        "hint": "Pergunta hipotética com 'What'.",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! A estrutura correta para esta pergunta hipotética é 'What would you say...?'." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. A condição 'if you were asked' torna a pergunta imaginária." },
            { "text": "did", "isCorrect": false, "rationale": "Incorreto. 'Did' é para o passado." },
            { "text": "do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente." }
        ]
    },
    {
        "question": "22. I would ______ a jacket if I were you. It's cold.",
        "topic": "Affirmative Form",
        "hint": "Depois de 'would', o verbo deve estar na sua forma mais simples.",
        "options": [
            { "text": "wear", "isCorrect": true, "rationale": "Correto! O verbo 'wear' (vestir) está na forma base, como deve ser após 'would'." },
            { "text": "wears", "isCorrect": false, "rationale": "Incorreto. O verbo nunca leva '-s' após 'would'." },
            { "text": "wore", "isCorrect": false, "rationale": "Incorreto. O verbo não pode estar no passado." },
            { "text": "wearing", "isCorrect": false, "rationale": "Incorreto. O verbo não pode estar no gerúndio (-ing)." }
        ]
    },
    {
        "question": "23. ______ you go to the party if you were invited?",
        "topic": "Interrogative Form",
        "hint": "Uma pergunta condicional sobre ir a uma festa.",
        "options": [
            { "text": "Would", "isCorrect": true, "rationale": "Correto! Perguntas sobre situações hipotéticas começam com 'Would'." },
            { "text": "Will", "isCorrect": false, "rationale": "Incorreto. A condição ('if you were invited') é imaginária." },
            { "text": "Did", "isCorrect": false, "rationale": "Incorreto. 'Did' é para o passado." },
            { "text": "Do", "isCorrect": false, "rationale": "Incorreto. 'Do' é para o presente." }
        ]
    },
    {
        "question": "24. They ______ eat fast food, even if they were very hungry.",
        "topic": "Negative Form",
        "hint": "A frase indica uma recusa hipotética.",
        "options": [
            { "text": "wouldn't", "isCorrect": true, "rationale": "Correto! 'Wouldn't' expressa que, mesmo na condição de estarem com fome, eles não fariam a ação." },
            { "text": "would", "isCorrect": false, "rationale": "Incorreto. 'Would' significaria que eles comeriam." },
            { "text": "won't", "isCorrect": false, "rationale": "Incorreto. 'Won't' se refere ao futuro real." },
            { "text": "didn't", "isCorrect": false, "rationale": "Incorreto. 'Didn't' se refere ao passado." }
        ]
    },
    {
        "question": "25. ______ he join our team if we asked him?",
        "topic": "Interrogative Form",
        "hint": "Como perguntamos sobre a possível reação de alguém a um convite?",
        "options": [
            { "text": "Would", "isCorrect": true, "rationale": "Correto! A pergunta explora uma possibilidade, por isso usa 'Would'." },
            { "text": "Will", "isCorrect": false, "rationale": "Incorreto. 'Will' implicaria que já decidimos perguntar a ele." },
            { "text": "Did", "isCorrect": false, "rationale": "Incorreto. 'Did' é passado." },
            { "text": "Does", "isCorrect": false, "rationale": "Incorreto. 'Does' é presente." }
        ]
    },
    {
        "question": "26. I'm so tired. I ______ sleep for a week!",
        "topic": "General Use",
        "hint": "A pessoa está exagerando para expressar o quanto está cansada. É uma hipérbole.",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! Usamos 'would' (ou 'could') para expressar desejos e situações imaginárias, como dormir por uma semana." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. 'Will' soaria como um plano real, o que é impossível." },
            { "text": "slept", "isCorrect": false, "rationale": "Incorreto. 'Slept' é passado." },
            { "text": "am", "isCorrect": false, "rationale": "Incorreto. Estrutura incorreta." }
        ]
    },
    {
        "question": "27. If we had a boat, we ______ sailing every weekend.",
        "topic": "Second Conditional",
        "hint": "A condição ('Se tivéssemos um barco') é imaginária.",
        "options": [
            { "text": "would go", "isCorrect": true, "rationale": "Correto! O resultado da condição imaginária é expresso com 'would' + verbo base." },
            { "text": "will go", "isCorrect": false, "rationale": "Incorreto. A irrealidade da condição ('had a boat') pede 'would', não 'will'." },
            { "text": "went", "isCorrect": false, "rationale": "Incorreto. Falta o auxiliar 'would'." },
            { "text": "go", "isCorrect": false, "rationale": "Incorreto. Falta o auxiliar 'would'." }
        ]
    },
    {
        "question": "28. He ______ be happy to help if you ask him nicely.",
        "topic": "Affirmative Form",
        "hint": "Esta frase descreve uma reação provável a uma condição.",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! 'He would be happy' (Ele ficaria feliz) é a consequência da condição." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. 'Will' também é possível, mas 'would' soa mais como uma garantia da reação dele na situação hipotética." },
            { "text": "is", "isCorrect": false, "rationale": "Incorreto. 'Is' é presente, mas a frase é condicional." },
            { "text": "was", "isCorrect": false, "rationale": "Incorreto. 'Was' é passado." }
        ]
    },
    {
        "question": "29. ______ you mind if I closed the door?",
        "topic": "Interrogative Form",
        "hint": "Uma forma muito educada de pedir permissão para fazer algo.",
        "options": [
            { "text": "Would", "isCorrect": true, "rationale": "Correto! A expressão 'Would you mind...?' (Você se importaria...?) é uma forma muito comum e polida de pedir permissão." },
            { "text": "Will", "isCorrect": false, "rationale": "Incorreto. Não usamos 'Will' nesta expressão educada." },
            { "text": "Do", "isCorrect": false, "rationale": "Incorreto. 'Do you mind...?' também é correto, mas 'Would' é ainda mais hipotético e suave." },
            { "text": "Can", "isCorrect": false, "rationale": "Incorreto. 'Can' não se encaixa nesta estrutura." }
        ]
    },
    {
        "question": "30. They ______ buy the house, but it was too expensive.",
        "topic": "Affirmative Form",
        "hint": "Eles tinham a intenção, mas algo os impediu.",
        "options": [
            { "text": "would", "isCorrect": true, "rationale": "Correto! 'They would buy' (Eles comprariam) indica a intenção que foi impedida pela condição (preço alto)." },
            { "text": "will", "isCorrect": false, "rationale": "Incorreto. 'Will' não faz sentido porque a decisão final foi não comprar." },
            { "text": "bought", "isCorrect": false, "rationale": "Incorreto. 'Bought' (compraram) contradiz a frase." },
            { "text": "wouldn't", "isCorrect": false, "rationale": "Incorreto. 'Wouldn't buy' (não comprariam) não se encaixa com a lógica da frase." }
                    ]
                }
            ],

            startQuiz(continueFromSavedState) {
                const studentCode = this.elements.studentCodeInput.value.trim().toUpperCase();
                const correctName = this.studentData[studentCode];

                if (!correctName) {
                    alert("Código de acesso inválido. Por favor, verifique e tente novamente.");
                    return;
                }

                this.validatedStudentCode = studentCode;
                this.validatedStudentName = correctName;

                if (continueFromSavedState) {
                    this.loadQuizState(this.validatedStudentCode);
                } else {
                    this.currentQuestionIndex = 0;
                    this.score = 0;
                    this.userAnswers = {};
                    this.skippedQuestions = [];
                    this.currentSkippedIndex = 0;
		    this.balanceCorrectAnswers();
                    localStorage.removeItem(`quizState_${this.validatedStudentCode}`);

                    this.shuffledQuestions = this.shuffleArray([...this.questions]);
                }

                const storageKey = `quiz_attempts_${this.validatedStudentCode}`;
                let attempts = parseInt(localStorage.getItem(storageKey) || 0);
                localStorage.setItem(storageKey, attempts + 1);

                this.elements.studentCodeInput.style.display = 'none';
                this.elements.startActionsDiv.style.display = 'none';
                this.elements.quizDescription.style.display = 'none';

                this.elements.personalizedWelcome.textContent = `Bem-vindo(a), ${this.validatedStudentName}! Boa sorte!`;
                this.elements.personalizedWelcome.style.display = 'block';

                setTimeout(() => {
                    this.elements.introCard.style.display = 'none';
                    this.elements.quizCard.style.display = 'flex';
                    this.displayQuestion();
                }, 3000);
            },

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            displayQuestion() {
                this.elements.performanceDisplay.style.display = 'none';
                let questionToDisplay;
                let currentQuestionNumber;
                this.elements.hintText.style.display = 'none';
                this.elements.summaryText.style.display = 'none';
                this.elements.summaryButton.style.display = 'none';

                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
                    const skippedIndex = this.skippedQuestions[this.currentSkippedIndex];
                    questionToDisplay = this.questions[skippedIndex]; 
                    currentQuestionNumber = `(Pulada) ${this.currentSkippedIndex + 1} de ${this.skippedQuestions.length}`;
                    this.elements.skipButton.style.display = 'none';
                    this.elements.nextButton.textContent = 'Próxima Questão';
                } else if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    questionToDisplay = this.shuffledQuestions[this.currentQuestionIndex];
                    currentQuestionNumber = this.currentQuestionIndex + 1;
                    this.elements.skipButton.style.display = 'inline-block';
                    this.elements.nextButton.textContent = 'Próxima Questão';
                } else {
                    this.showResults();
                    return;
                }

                this.elements.currentQuestionNumSpan.textContent = currentQuestionNumber;
                this.elements.nextButton.style.display = 'none';
                this.elements.optionsList.innerHTML = '';
                this.elements.questionText.textContent = questionToDisplay.question;

                questionToDisplay.options.forEach((option, index) => {
                    const li = document.createElement('li');
                    li.className = 'option-item';
                    li.textContent = option.text;
                    li.onclick = () => this.selectOption(li, option);
                    this.elements.optionsList.appendChild(li);
                });
            },

            selectOption(selectedElement, selectedOption) {
                const options = document.querySelectorAll('.option-item');

                options.forEach(option => {
                    option.style.pointerEvents = 'none';
                });

                const justificationElement = document.createElement('div');
                justificationElement.className = 'justification';

                let currentQuestion;
                let originalQuestionIndex;

                if (this.currentQuestionIndex >= this.shuffledQuestions.length) {
                    originalQuestionIndex = this.skippedQuestions[this.currentSkippedIndex];
                    currentQuestion = this.questions[originalQuestionIndex];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    originalQuestionIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
                }

                const correctOptions = currentQuestion.options.filter(opt => opt.isCorrect);
                const correctOptionTexts = correctOptions.map(opt => opt.text);
                const isCorrect = correctOptionTexts.includes(selectedOption.text);

                if (isCorrect) {
                    this.score++;
                    selectedElement.classList.add('correct');
                    justificationElement.textContent = selectedOption.rationale;
                    justificationElement.style.borderColor = '#28a745';
                    this.elements.summaryButton.style.display = 'none';
                } else {
                    selectedElement.classList.add('incorrect');
                    const correctElements = Array.from(options).filter(el => correctOptionTexts.includes(el.textContent));
                    correctElements.forEach(el => el.classList.add('correct'));
                    justificationElement.textContent = selectedOption.rationale;
                    justificationElement.style.borderColor = '#dc3545';
                    this.elements.summaryButton.style.display = 'inline-block';
                }

                this.userAnswers[originalQuestionIndex] = {
                    question: currentQuestion.question,
                    userAnswer: selectedOption.text,
                    isCorrect: isCorrect,
                    correctAnswer: correctOptionTexts.join(' ou '),
                    rationale: selectedOption.rationale
                };

                selectedElement.parentNode.insertBefore(justificationElement, selectedElement.nextSibling);
                justificationElement.style.display = 'block';

                this.elements.nextButton.style.display = 'block';
                this.elements.skipButton.style.display = 'none'; 
                this.saveQuizState();
            },

            showPerformance() {
                const answeredCount = Object.keys(this.userAnswers).length;
                const correctCount = this.score;
                const incorrectCount = answeredCount - correctCount;

                this.elements.performanceDisplay.innerHTML = `Até agora: <span style="color: #28a745;">${correctCount} acertos</span> e <span style="color: #dc3545;">${incorrectCount} erros</span>.`;
                this.elements.performanceDisplay.style.display = 'block';
            },
            
            showHint() {
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }

                if (currentQuestion && currentQuestion.hint) {
                    this.elements.hintText.textContent = currentQuestion.hint;
                    this.elements.hintText.style.display = 'block';
                }
            },

            showSummary() {
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }
                
                const questionTopic = currentQuestion.topic;

                if (questionTopic && this.summaries[questionTopic]) {
                    this.elements.summaryText.textContent = this.summaries[questionTopic];
                    this.elements.summaryText.style.display = 'block';
                }
            },

            nextQuestion() {
                if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    this.currentQuestionIndex++;
                } else {
                    this.currentSkippedIndex++;
                }
                
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.currentSkippedIndex >= this.skippedQuestions.length) {
                    this.showResults();
                } else {
                    this.displayQuestion();
                }
            },

            skipQuestion() {
                if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    const originalIndex = this.questions.findIndex(q => q.question === this.shuffledQuestions[this.currentQuestionIndex].question);
                    this.skippedQuestions.push(originalIndex);
                }
                this.currentQuestionIndex++;
                this.displayQuestion();
            },

            getClassification(percentage) {
                if (percentage >= 86) return "Excelente!!!";
                if (percentage >= 71) return "Muito Bom!!";
                if (percentage >= 51) return "Bom!";
                if (percentage >= 0) return "Insatisfatório!";
                return "Classificação não disponível";
            },

            launchConfetti() {
                confetti({ particleCount: 600, spread: 70, origin: { y: 0.6 } });
                setTimeout(() => confetti({ particleCount: 450, spread: 90, origin: { x: 0, y: 0.8 } }), 500);
                setTimeout(() => confetti({ particleCount: 450, spread: 90, origin: { x: 1, y: 0.8 } }), 800);
                setTimeout(() => confetti({ particleCount: 300, spread: 120, origin: { y: 0.2 } }), 1000);
            },

            showResults() {
                this.elements.quizCard.style.display = 'none';
                this.elements.resultsCard.style.display = 'block';
                this.elements.incorrectQuestionsContainer.innerHTML = '';
                this.elements.fullReportContainer.innerHTML = '';
                localStorage.removeItem(`quizState_${this.validatedStudentCode}`);

                const percentage = Math.round((this.score / this.questions.length) * 100);
                const classificationText = this.getClassification(percentage);

                this.elements.reportStudentName.textContent = this.validatedStudentName;
                this.elements.reportStudentCode.textContent = this.validatedStudentCode;
                this.elements.scoreDisplay.textContent = `${this.score} de ${this.questions.length}`;
                this.elements.percentageDisplay.textContent = `${percentage}%`;

                this.elements.classificationDisplay.textContent = classificationText;
                this.elements.classificationDisplay.classList.remove('classification-red', 'classification-blue', 'classification-orange');
                if (classificationText === "Insatisfatório!") {
                    this.elements.classificationDisplay.classList.add('classification-red');
                } else if (classificationText === "Excelente!!!") {
                    this.launchConfetti();
                    this.elements.classificationDisplay.classList.add('classification-orange');
                    setTimeout(() => {
                        this.elements.classificationDisplay.classList.remove('classification-orange');
                        this.elements.classificationDisplay.style.color = '#FFA500';
                        this.elements.classificationDisplay.style.fontWeight = 'bold';
                        this.elements.classificationDisplay.style.animation = 'none';
                    }, 5000);
                } else if (classificationText === "Muito Bom!!" || classificationText === "Bom!") {
                    this.elements.classificationDisplay.classList.add('classification-blue');
                }

                this.elements.fullReportContainer.innerHTML = this.generateFullReportHtml();
                this.elements.fullReportContainer.style.display = 'block';

                const shareMessage = this.generateShareMessage(percentage, classificationText);
                const encodedMessage = encodeURIComponent(shareMessage);
                this.elements.shareWhatsappLink.href = `https://wa.me/?text=${encodedMessage}`;

                const data = {
                    nome: this.validatedStudentName,
                    codigo: this.validatedStudentCode,
                    pontuacao: `${this.score} de ${this.questions.length}`,
                    percentual: `${percentage}%`,
                    classificacao: classificationText,
                };

                fetch(this.APP_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'no-cors'
                })
                .then(() => console.log('Dados enviados com sucesso para a planilha!'))
                .catch(error => console.error('Erro ao enviar dados:', error));

                this.elements.sendReportLink.textContent = 'Relatório Enviado!';
                this.elements.sendReportLink.href = '#';
                this.elements.sendReportLink.onclick = (e) => e.preventDefault();
                this.elements.sendReportLink.style.cursor = 'default';
                this.elements.sendReportLink.style.backgroundColor = '#ccc';
            },

            generateFullReportHtml() {
                let html = '<h3>Relatório Completo de Respostas:</h3>';
                this.questions.forEach((question, index) => {
                    const userAnswerObj = this.userAnswers[index] || {};
                    const userAnswerText = userAnswerObj.userAnswer;
                    const isCorrect = userAnswerObj.isCorrect;
                    
                    html += `<div class="report-question-item">`;
                    html += `<p><strong>Questão ${index + 1}:</strong> ${question.question}</p>`;
                    html += `<ul style="list-style-type: none; padding-left: 0;">`;

                    question.options.forEach(option => {
                        const isUserAnswer = (option.text === userAnswerText);
                        const isCorrectOption = option.isCorrect;

                        let optionClass = '';
                        if (isCorrectOption) {
                            optionClass = 'correct';
                        } else if (isUserAnswer) {
                            optionClass = 'incorrect';
                        }

                        let textPrefix = '';
                        if (isUserAnswer && isCorrectOption) {
                            textPrefix = 'Sua Resposta Correta: ';
                        } else if (isCorrectOption) {
                            textPrefix = 'Resposta Correta: ';
                        } else if (isUserAnswer) {
                            textPrefix = 'Sua Resposta: ';
                        }

                        html += `<li class="option-item-report ${optionClass}">`;
                        html += `<p><strong>${textPrefix}</strong>${option.text}</p>`;
                        html += `<div class="justification" style="display: block;">${option.rationale}</div>`;
                        html += `</li>`;
                    });

                    html += '</ul></div>';
                });
                return html;
            },

            generateShareMessage(percentage, classificationText) {
                let message = `*Relatório Completo do Quiz de Inglês*\n\n`;
                message += `*Aluno(a):* ${this.validatedStudentName}\n`;
                message += `*Código de Acesso:* ${this.validatedStudentCode}\n`;
                message += `*Pontuação:* ${this.score} de ${this.questions.length}\n`;
                message += `*Percentual de Acerto:* ${percentage}%\n`;
                message += `*Classificação:* ${classificationText}\n\n`;
                message += `*--- Respostas ---*\n`;

                this.questions.forEach((question, index) => {
                    const userAnswerObj = this.userAnswers[index] || {};
                    const userAnswerText = userAnswerObj.userAnswer || 'Não respondida';
                    const isCorrect = userAnswerObj.isCorrect;
                    const correctAnswer = question.options.find(opt => opt.isCorrect).text;
                    const rationale = userAnswerObj.rationale || question.options.find(opt => opt.isCorrect).rationale;

                    message += `\n*Questão ${index + 1}:* ${question.question}\n`;
                    message += `_Sua resposta:_ ${isCorrect ? `😄` : `😢`} ${userAnswerText}\n`;
                    message += `_Resposta correta:_ ${correctAnswer}\n`;
                    message += `_Justificativa:_ ${rationale}\n`;
                });
                return message;
            },

            saveQuizState() {
                const quizState = {
                    questionIndex: this.currentQuestionIndex,
                    userResponses: this.userAnswers,
                    studentCode: this.validatedStudentCode,
                    studentName: this.validatedStudentName,
                    skippedQuestions: this.skippedQuestions,
                    currentSkippedIndex: this.currentSkippedIndex,
                    shuffledQuestions: this.shuffledQuestions // Salva a ordem embaralhada
                };
                localStorage.setItem(`quizState_${this.validatedStudentCode}`, JSON.stringify(quizState));
            },

            loadQuizState(studentCode) {
                const savedState = localStorage.getItem(`quizState_${studentCode}`);
                if (savedState) {
                    const quizState = JSON.parse(savedState);
                    if (quizState.studentCode === studentCode) {
                        this.currentQuestionIndex = quizState.questionIndex;
                        this.score = quizState.score || Object.values(quizState.userResponses).filter(a => a.isCorrect).length;
                        this.userAnswers = quizState.userResponses || {};
                        this.validatedStudentName = quizState.studentName;
                        this.validatedStudentCode = quizState.studentCode;
                        this.skippedQuestions = quizState.skippedQuestions || [];
                        this.currentSkippedIndex = quizState.currentSkippedIndex || 0;
                        this.shuffledQuestions = quizState.shuffledQuestions;
                        return true;
                    }
                }
                return false;
            },

            updateAttemptsDisplay(code) {
                this.elements.attemptsLeftSpan.textContent = "Ilimitadas";
                this.elements.introAttemptsLeftSpan.textContent = "ilimitadas";
                this.elements.startActionsDiv.innerHTML = '';
                
                if (this.loadQuizState(code)) {
                    const continueBtn = document.createElement('button');
                    continueBtn.textContent = 'Continuar Quiz';
                    continueBtn.className = 'start-btn continue-btn';
                    continueBtn.onclick = () => this.startQuiz(true);
                    this.elements.startActionsDiv.appendChild(continueBtn);

                    const newBtn = document.createElement('button');
                    newBtn.textContent = 'Iniciar Novo Quiz';
                    newBtn.className = 'start-btn';
                    newBtn.style.backgroundColor = '#dc3545';
                    newBtn.onclick = () => {
                        if (confirm("Você tem um progresso salvo. Deseja realmente começar um novo quiz e perder o progresso atual?")) {
                            this.startQuiz(false);
                        }
                    };
                    this.elements.startActionsDiv.appendChild(newBtn);
                } else {
                    const startBtn = document.createElement('button');
                    startBtn.textContent = 'Start Quiz';
                    startBtn.className = 'start-btn';
                    startBtn.onclick = () => this.startQuiz(false);
                    this.elements.startActionsDiv.appendChild(startBtn);
                }
            },

            restartQuiz() {
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.userAnswers = {};
                this.skippedQuestions = [];
                this.currentSkippedIndex = 0;

                const studentCode = this.elements.studentCodeInput.value.trim().toUpperCase();
                if (studentCode) {
                    localStorage.removeItem(`quizState_${studentCode}`);
                }

                this.elements.resultsCard.style.display = 'none';
                this.elements.quizCard.style.display = 'none';
                this.elements.introCard.style.display = 'flex';
                this.elements.studentCodeInput.value = '';
                this.elements.studentCodeInput.style.display = 'block';
                this.elements.personalizedWelcome.style.display = 'none';
                this.elements.quizDescription.style.display = 'block';
                this.elements.sendReportLink.textContent = 'Enviar Relatório ao Professor';
                this.elements.sendReportLink.href = '#';
                this.elements.sendReportLink.onclick = null;
                this.elements.sendReportLink.style.cursor = 'pointer';
                this.elements.sendReportLink.style.backgroundColor = '#6c757d';

                this.elements.startActionsDiv.innerHTML = '<button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>';
                this.elements.startActionsDiv.style.display = 'block';
            },

            saveReport() {
                const scoreText = this.elements.scoreDisplay.textContent;
                const percentage = Math.round((this.score / this.questions.length) * 100);
                const classificationText = this.elements.classificationDisplay.textContent;

                let reportContent = `Relatório Completo do Quiz de Inglês\n\n`;
                reportContent += `Nome: ${this.validatedStudentName}\n`;
                reportContent += `Código de Acesso: ${this.validatedStudentCode}\n`;
                reportContent += `Pontuação: ${scoreText}\n`;
                reportContent += `Percentual de Acerto: ${percentage}%\n`;
                reportContent += `Classificação: ${classificationText}\n\n`;
                reportContent += `--- Respostas ---\n`;

                this.questions.forEach((question, index) => {
                    const userAnswerObj = this.userAnswers[index] || {};
                    const userAnswerText = userAnswerObj.userAnswer || 'Não respondida';
                    const isCorrect = userAnswerObj.isCorrect;
                    const correctAnswer = question.options.find(opt => opt.isCorrect).text;
                    const rationale = userAnswerObj.rationale || question.options.find(opt => opt.isCorrect).rationale;

                    reportContent += `\nQuestão ${index + 1}: ${question.question}\n`;
                    reportContent += `Sua resposta: ${isCorrect ? `(CORRETA) ` : `(INCORRETA) `}${userAnswerText}\n`;
                    reportContent += `Resposta correta: ${correctAnswer}\n`;
                    reportContent += `Justificativa: ${rationale}\n`;
                });

                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Relatorio-Quiz-${this.validatedStudentName.replace(/ /g, '-')}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            printReport() {
                window.print();
            },

            init() {
                this.elements.studentCodeInput.addEventListener('input', (e) => {
                    e.target.value = e.target.value.toUpperCase();
                    const code = e.target.value.trim().toUpperCase();
                    if (this.studentData[code]) {
                        this.updateAttemptsDisplay(code);
                    } else {
                        this.elements.startActionsDiv.innerHTML = '<button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>';
                    }
                });

                this.elements.performanceButton.onclick = () => this.showPerformance();
                this.elements.nextButton.onclick = () => this.nextQuestion();
                this.elements.skipButton.onclick = () => this.skipQuestion(); // Nova função
                //this.elements.restartBtn.onclick = () => this.restartQuiz();
                //this.elements.saveReportBtn.onclick = () => this.saveReport();
                //this.elements.printBtn.onclick = () => this.printReport();

                const code = this.elements.studentCodeInput.value.trim().toUpperCase();
                if (this.studentData[code]) {
                    this.updateAttemptsDisplay(code);
                } else {
                    this.restartQuiz();
                }
            }
        };

        window.onload = function() {
            quizApp.init();
        };

    </script>
</body>
</html>